!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="ea5458b6-bcc8-4583-b978-9dd5096484fd",e._sentryDebugIdIdentifier="sentry-dbid-ea5458b6-bcc8-4583-b978-9dd5096484fd")}catch(e){}}();var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"2dc6c61e76886309b3cd5c123cc0de71e3e4ba59"},(self.webpackChunkschema_diagram_vue=self.webpackChunkschema_diagram_vue||[]).push([[958],{72212:function(e,t,n){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"});const s=n(2543);var i,r=((i=r||{}).SPACE="<space>",i.TAB="<tab>",i.NEWLINE="<newline>",i.COMMA="<comma>",i.LPAREN="<lparen>",i.RPAREN="<rparen>",i.LBRACE="<lbrace>",i.RBRACE="<rbrace>",i.LBRACKET="<lbracket>",i.RBRACKET="<rbracket>",i.LANGLE="<langle>",i.RANGLE="<rangle>",i.OP="<op>",i.EOF="<eof>",i.NUMERIC_LITERAL="<number>",i.STRING_LITERAL="<string>",i.COLOR_LITERAL="<color>",i.FUNCTION_EXPRESSION="<function-expression>",i.QUOTED_STRING="<variable>",i.IDENTIFIER="<identifier>",i.SEMICOLON="<semicolon>",i.COLON="<colon>",i.SINGLE_LINE_COMMENT="<single-line-comment>",i.MULTILINE_COMMENT="<multiline-comment>",i);function a(e){switch(e.kind){case"<newline>":case"<space>":case"<tab>":case"<single-line-comment>":case"<multiline-comment>":return!0;default:return!1}}function o(e){if(!e)return!1;switch(e){case"+":case"-":case"*":case"/":case"%":case"<":case">":case"=":case"!":case".":case"&":case"|":return!0;default:return!1}}function l(e){return void 0!==e&&"<op>"===e.kind}class c{constructor(e,t,n,s,i){this.kind=e,this.startPos=t,this.endPos=n,this.value=s,this.leadingTrivia=[],this.trailingTrivia=[],this.leadingInvalid=[],this.trailingInvalid=[],this.isInvalid=i,this.start=t.offset,this.end=n.offset}static create(e,t,n,s,i){return new c(e,t,n,s,i)}}function u(e){return void 0!==e.trailingTrivia.find((({kind:e})=>e===r.NEWLINE))}function h(e,t){return void 0!==t.leadingTrivia.find((({kind:e})=>e===r.NEWLINE))||u(e)}function d(e){return void 0!==e.trailingTrivia.find((({kind:e})=>[r.SPACE,r.TAB].includes(e)))}function p(e){return 0===e.trailingTrivia.length?e.end:p(s.last(e.trailingTrivia))}function E(e){return 0===e.leadingTrivia.length?e.start:E(e.leadingTrivia[0])}class f{constructor(){this.id=0}reset(){this.id=0}nextId(){return this.id++}}class N{constructor(e,t,n){this.id=e,this.kind=t;const s=n.find((e=>void 0!==e&&!Number.isNaN(e.start)));s?(this.startPos=s.startPos,this.fullStart=s instanceof c?E(s):s.fullStart):(this.startPos={offset:NaN,column:NaN,line:NaN},this.fullStart=NaN);const i=[...n].reverse().find((e=>void 0!==e&&!Number.isNaN(e.end)));i?(this.endPos=i.endPos,this.fullEnd=i instanceof c?p(i):i.fullEnd):(this.endPos={offset:NaN,column:NaN,line:NaN},this.fullEnd=NaN),this.start=this.startPos.offset,this.end=this.endPos.offset}}var m=(e=>(e.PROGRAM="<program>",e.ELEMENT_DECLARATION="<element-declaration>",e.ATTRIBUTE="<attribute>",e.IDENTIFIER_STREAM="<identifer-stream>",e.LITERAL="<literal>",e.VARIABLE="<variable>",e.PREFIX_EXPRESSION="<prefix-expression>",e.INFIX_EXPRESSION="<infix-expression>",e.POSTFIX_EXPRESSION="<postfix-expression>",e.FUNCTION_EXPRESSION="<function-expression>",e.FUNCTION_APPLICATION="<function-application>",e.BLOCK_EXPRESSION="<block-expression>",e.LIST_EXPRESSION="<list-expression>",e.TUPLE_EXPRESSION="<tuple-expression>",e.CALL_EXPRESSION="<call-expression>",e.PRIMARY_EXPRESSION="<primary-expression>",e.GROUP_EXPRESSION="<group-expression>",e.DUMMY="<dummy>",e.ARRAY="<array>",e))(m||{});class T extends N{constructor({body:e=[],eof:t},n){super(n,"<program>",[...e,t]),this.body=e,this.eof=t}}class b extends N{constructor({type:e,name:t,as:n,alias:s,attributeList:i,bodyColon:r,body:a},o){if(super(o,"<element-declaration>",[e,t,n,s,i,r,a]),a&&r&&!(a instanceof A||a instanceof b))throw new Error("If an element has a simple body, it must be a function application node");this.type=e,this.name=t,this.as=n,this.alias=s,this.attributeList=i,this.bodyColon=r,this.body=a}}class v extends N{constructor({identifiers:e=[]},t){super(t,"<identifer-stream>",e||[]),this.identifiers=e}}class I extends N{constructor({name:e,colon:t,value:n},s){super(s,"<attribute>",[e,t,n]),this.name=e,this.value=n,this.colon=t}}class L extends N{constructor({op:e,expression:t},n){super(n,"<prefix-expression>",[e,t]),this.op=e,this.expression=t}}class _ extends N{constructor({op:e,leftExpression:t,rightExpression:n},s){super(s,"<infix-expression>",[t,e,n]),this.op=e,this.leftExpression=t,this.rightExpression=n}}class y extends N{constructor({op:e,expression:t},n){super(n,"<postfix-expression>",[t,e]),this.op=e,this.expression=t}}class g extends N{constructor({value:e},t){super(t,"<function-expression>",[e]),this.value=e}}class A extends N{constructor({callee:e,args:t=[]},n){super(n,"<function-application>",[e,...t]),this.callee=e,this.args=t}}class w extends N{constructor({blockOpenBrace:e,body:t=[],blockCloseBrace:n},s){super(s,"<block-expression>",[e,...t,n]),this.blockOpenBrace=e,this.body=t,this.blockCloseBrace=n}}class C extends N{constructor({listOpenBracket:e,elementList:t=[],commaList:n=[],listCloseBracket:s},i){super(i,"<list-expression>",[e,...M(t,n),s]),this.listOpenBracket=e,this.elementList=t,this.commaList=n,this.listCloseBracket=s}}class k extends N{constructor({tupleOpenParen:e,elementList:t=[],commaList:n=[],tupleCloseParen:s},i){super(i,"<tuple-expression>",[e,...M(t,n),s]),this.tupleOpenParen=e,this.elementList=t,this.commaList=n,this.tupleCloseParen=s}}class S extends k{constructor({groupOpenParen:e,expression:t,groupCloseParen:n},s){super({tupleOpenParen:e,elementList:t&&[t],commaList:[],tupleCloseParen:n},s),this.kind="<group-expression>"}}class x extends N{constructor({callee:e,argumentList:t},n){super(n,"<call-expression>",[e,t]),this.callee=e,this.argumentList=t}}class O extends N{constructor({literal:e},t){super(t,"<literal>",[e]),this.literal=e}}class D extends N{constructor({variable:e},t){super(t,"<variable>",[e]),this.variable=e}}class R extends N{constructor({expression:e},t){super(t,"<primary-expression>",[e]),this.expression=e}}class P extends N{constructor({pre:e},t){super(t,"<dummy>",[c.create(r.SPACE,e.endPos,e.endPos," ",!1)])}}class U extends N{constructor({expression:e,indexer:t},n){super(n,"<array>",[e,t]),this.array=e,this.indexer=t}}function M(e,t){if(!e||0===e.length)return t||[];if(!t||0===t.length)return e||[];const[n]=e,[i]=t;return(n.start<i.start?s.flatten(s.zip(e,t)):s.flatten(s.zip(t,e))).filter((e=>null!==e))}class F{constructor(e){this.value=e}unwrap(){return this.value}unwrap_or(e){return this.value}and_then(e){return e(this.value)}map(e){return new F(e(this.value))}isOk(){return!0}}class B{unwrap(){throw new Error("Trying to unwrap a None value")}unwrap_or(e){return e}and_then(e){return new B}map(e){return new B}isOk(){return!1}}var G=(e=>(e.Schema="Schema",e.Table="Table",e.Column="Column",e.TableGroup="TableGroup",e.TableGroupField="TableGroup field",e.Enum="Enum",e.EnumField="Enum field",e.Note="Note",e))(G||{});function V(e){return`Schema:${e}`}function X(e){return`Table:${e}`}function K(e){return`Column:${e}`}function $(e){return`Enum:${e}`}function W(e){return`Enum field:${e}`}function j(e){return`TableGroup:${e}`}function Y(e){return`TableGroup field:${e}`}function q(e,t){switch(t){case"Column":return K(e);case"Enum":return $(e);case"Enum field":return W(e);case"Schema":return V(e);case"Table":return X(e);case"TableGroup":return j(e);case"TableGroup field":return Y(e);default:throw new Error("Unreachable")}}function z(e){const[t,n]=e.split(":");return Object.values(G).includes(t)?new F({name:n,kind:t}):new B}function Q(e){return[V,X,$,j,K,W,Y].map((t=>t(e)))}function H(e){return!!e.match(/(\p{L}|_|\p{M})/gu)}function J(e){const[t]=e;return t>="0"&&t<="9"}function Z(e){const[t]=e;return J(t)||H(t)&&t.toLowerCase()>="a"&&t.toLowerCase()<="f"}function ee(e){return H(e)||J(e)}function te(e,t){const n=[],s=Math.min(e.length,t.length);for(let i=0;i<s;i+=1)n.push(e[i],t[i]);return n.push(...e.slice(s),...t.slice(s)),n}function ne(e,t){return e>=t.start&&e<t.end}class se{constructor(){this.id=0}reset(){this.id=0}nextId(){return this.id++}}class ie{constructor({symbolTable:e},t){this.references=[],this.id=t,this.symbolTable=e}}class re{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class ae{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class oe{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class le{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class ce{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class ue{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}var he=(e=>(e[e.UNKNOWN_SYMBOL=1e3]="UNKNOWN_SYMBOL",e[e.UNEXPECTED_SYMBOL=1001]="UNEXPECTED_SYMBOL",e[e.UNEXPECTED_EOF=1002]="UNEXPECTED_EOF",e[e.UNEXPECTED_NEWLINE=1003]="UNEXPECTED_NEWLINE",e[e.UNKNOWN_TOKEN=1004]="UNKNOWN_TOKEN",e[e.UNEXPECTED_TOKEN=1005]="UNEXPECTED_TOKEN",e[e.UNEXPECTED_ELEMENT_DECLARATION=1006]="UNEXPECTED_ELEMENT_DECLARATION",e[e.MISSING_SPACES=1007]="MISSING_SPACES",e[e.UNKNOWN_PREFIX_OP=1008]="UNKNOWN_PREFIX_OP",e[e.INVALID_OPERAND=1009]="INVALID_OPERAND",e[e.EMPTY_ATTRIBUTE_NAME=1010]="EMPTY_ATTRIBUTE_NAME",e[e.INVALID_ESCAPE_SEQUENCE=1011]="INVALID_ESCAPE_SEQUENCE",e[e.INVALID_NAME=3e3]="INVALID_NAME",e[e.UNEXPECTED_NAME=3001]="UNEXPECTED_NAME",e[e.NAME_NOT_FOUND=3002]="NAME_NOT_FOUND",e[e.DUPLICATE_NAME=3003]="DUPLICATE_NAME",e[e.INVALID_ALIAS=3004]="INVALID_ALIAS",e[e.UNEXPECTED_ALIAS=3005]="UNEXPECTED_ALIAS",e[e.UNEXPECTED_SETTINGS=3006]="UNEXPECTED_SETTINGS",e[e.INVALID_SETTINGS=3007]="INVALID_SETTINGS",e[e.UNEXPECTED_SIMPLE_BODY=3008]="UNEXPECTED_SIMPLE_BODY",e[e.UNEXPECTED_COMPLEX_BODY=3009]="UNEXPECTED_COMPLEX_BODY",e[e.INVALID_TABLE_CONTEXT=3010]="INVALID_TABLE_CONTEXT",e[e.INVALID_TABLE_SETTING=3011]="INVALID_TABLE_SETTING",e[e.DUPLICATE_TABLE_SETTING=3012]="DUPLICATE_TABLE_SETTING",e[e.INVALID_TABLEGROUP_CONTEXT=3013]="INVALID_TABLEGROUP_CONTEXT",e[e.INVALID_TABLEGROUP_ELEMENT_NAME=3014]="INVALID_TABLEGROUP_ELEMENT_NAME",e[e.DUPLICATE_TABLEGROUP_ELEMENT_NAME=3015]="DUPLICATE_TABLEGROUP_ELEMENT_NAME",e[e.DUPLICATE_TABLEGROUP_FIELD_NAME=3016]="DUPLICATE_TABLEGROUP_FIELD_NAME",e[e.INVALID_TABLEGROUP_FIELD=3017]="INVALID_TABLEGROUP_FIELD",e[e.EMPTY_TABLE=3018]="EMPTY_TABLE",e[e.INVALID_COLUMN=3019]="INVALID_COLUMN",e[e.INVALID_COLUMN_NAME=3020]="INVALID_COLUMN_NAME",e[e.UNKNOWN_COLUMN_SETTING=3021]="UNKNOWN_COLUMN_SETTING",e[e.INVALID_COLUMN_TYPE=3022]="INVALID_COLUMN_TYPE",e[e.DUPLICATE_COLUMN_NAME=3023]="DUPLICATE_COLUMN_NAME",e[e.DUPLICATE_COLUMN_SETTING=3024]="DUPLICATE_COLUMN_SETTING",e[e.INVALID_COLUMN_SETTING_VALUE=3025]="INVALID_COLUMN_SETTING_VALUE",e[e.INVALID_ENUM_CONTEXT=3026]="INVALID_ENUM_CONTEXT",e[e.INVALID_ENUM_ELEMENT_NAME=3027]="INVALID_ENUM_ELEMENT_NAME",e[e.INVALID_ENUM_ELEMENT=3028]="INVALID_ENUM_ELEMENT",e[e.DUPLICATE_ENUM_ELEMENT_NAME=3029]="DUPLICATE_ENUM_ELEMENT_NAME",e[e.UNKNOWN_ENUM_ELEMENT_SETTING=3030]="UNKNOWN_ENUM_ELEMENT_SETTING",e[e.DUPLICATE_ENUM_ELEMENT_SETTING=3031]="DUPLICATE_ENUM_ELEMENT_SETTING",e[e.INVALID_ENUM_ELEMENT_SETTING=3032]="INVALID_ENUM_ELEMENT_SETTING",e[e.EMPTY_ENUM=3033]="EMPTY_ENUM",e[e.INVALID_REF_CONTEXT=3034]="INVALID_REF_CONTEXT",e[e.UNKNOWN_REF_SETTING=3035]="UNKNOWN_REF_SETTING",e[e.DUPLICATE_REF_SETTING=3036]="DUPLICATE_REF_SETTING",e[e.INVALID_REF_SETTING_VALUE=3037]="INVALID_REF_SETTING_VALUE",e[e.INVALID_REF_RELATIONSHIP=3038]="INVALID_REF_RELATIONSHIP",e[e.INVALID_REF_FIELD=3039]="INVALID_REF_FIELD",e[e.EMPTY_REF=3040]="EMPTY_REF",e[e.REF_REDEFINED=3041]="REF_REDEFINED",e[e.INVALID_NOTE_CONTEXT=3042]="INVALID_NOTE_CONTEXT",e[e.INVALID_NOTE=3043]="INVALID_NOTE",e[e.NOTE_REDEFINED=3044]="NOTE_REDEFINED",e[e.NOTE_CONTENT_REDEFINED=3045]="NOTE_CONTENT_REDEFINED",e[e.EMPTY_NOTE=3046]="EMPTY_NOTE",e[e.INVALID_INDEXES_CONTEXT=3047]="INVALID_INDEXES_CONTEXT",e[e.INVALID_INDEXES_FIELD=3048]="INVALID_INDEXES_FIELD",e[e.INVALID_INDEX=3049]="INVALID_INDEX",e[e.UNKNOWN_INDEX_SETTING=3050]="UNKNOWN_INDEX_SETTING",e[e.DUPLICATE_INDEX_SETTING=3051]="DUPLICATE_INDEX_SETTING",e[e.UNEXPECTED_INDEX_SETTING_VALUE=3052]="UNEXPECTED_INDEX_SETTING_VALUE",e[e.INVALID_INDEX_SETTING_VALUE=3053]="INVALID_INDEX_SETTING_VALUE",e[e.INVALID_PROJECT_CONTEXT=3054]="INVALID_PROJECT_CONTEXT",e[e.PROJECT_REDEFINED=3055]="PROJECT_REDEFINED",e[e.INVALID_PROJECT_FIELD=3056]="INVALID_PROJECT_FIELD",e[e.INVALID_CUSTOM_CONTEXT=3057]="INVALID_CUSTOM_CONTEXT",e[e.INVALID_CUSTOM_ELEMENT_VALUE=3058]="INVALID_CUSTOM_ELEMENT_VALUE",e[e.INVALID_ELEMENT_IN_SIMPLE_BODY=3059]="INVALID_ELEMENT_IN_SIMPLE_BODY",e[e.BINDING_ERROR=4e3]="BINDING_ERROR",e[e.UNSUPPORTED=5e3]="UNSUPPORTED",e[e.CIRCULAR_REF=5001]="CIRCULAR_REF",e[e.SAME_ENDPOINT=5002]="SAME_ENDPOINT",e[e.UNEQUAL_FIELDS_BINARY_REF=5003]="UNEQUAL_FIELDS_BINARY_REF",e[e.CONFLICTING_SETTING=5004]="CONFLICTING_SETTING",e[e.TABLE_REAPPEAR_IN_TABLEGROUP=5005]="TABLE_REAPPEAR_IN_TABLEGROUP",e))(he||{});class de extends Error{constructor(e,t,n){super(t),this.code=e,this.diagnostic=t,this.nodeOrToken=n,this.start=n.start,this.end=n.end,this.name=this.constructor.name,Object.setPrototypeOf(this,de.prototype)}}class pe{constructor(e,t){this.value=e,this.errors=void 0===t?[]:t}getValue(){return this.value}getErrors(){return this.errors}chain(e){const t=e(this.value),n=[...this.errors,...t.errors];return new pe(t.value,n)}map(e){return new pe(e(this.value),this.errors)}}function Ee(e){return e.kind===r.IDENTIFIER&&"as"===e.value}function fe(e){e&&(e instanceof c?function(e){e.kind!==r.EOF&&(e.isInvalid=!0)}(e):function(e){if(e instanceof b)fe(e.type),fe(e.name),fe(e.as),fe(e.alias),fe(e.bodyColon),fe(e.attributeList),fe(e.body);else if(e instanceof v)e.identifiers.forEach(fe);else if(e instanceof I)fe(e.name),fe(e.colon),fe(e.value);else if(e instanceof L)fe(e.op),fe(e.expression);else if(e instanceof _)fe(e.leftExpression),fe(e.op),fe(e.rightExpression);else if(e instanceof y)fe(e.op),fe(e.expression);else if(e instanceof w)fe(e.blockOpenBrace),e.body.forEach(fe),fe(e.blockCloseBrace);else if(e instanceof C)fe(e.listOpenBracket),e.commaList.forEach(fe),e.elementList.forEach(fe),fe(e.listCloseBracket);else if(e instanceof k)fe(e.tupleOpenParen),e.commaList.forEach(fe),e.elementList.forEach(fe),fe(e.tupleCloseParen);else if(e instanceof x)fe(e.callee),fe(e.argumentList);else if(e instanceof A)fe(e.callee),e.args.forEach(fe);else if(e instanceof R)fe(e.expression);else if(e instanceof g)fe(e.value);else if(e instanceof D)fe(e.variable);else{if(!(e instanceof O))throw e instanceof S?new Error("This case is handled by the TupleExpressionNode case"):new Error("Unreachable case in markInvalidNode");fe(e.literal)}}(e))}function Ne(e){return!(null==e||!e.isInvalid)}function me(...e){return e.filter((e=>void 0!==e))}function Te(e){if(e instanceof T)return me(...e.body,e.eof);if(e instanceof b)return me(e.type,e.name,e.as,e.alias,e.attributeList,e.bodyColon,e.body);if(e instanceof I)return me(e.name,e.colon,e.value);if(e instanceof v)return e.identifiers;if(e instanceof O)return e.literal?[e.literal]:[];if(e instanceof D)return me(e.variable);if(e instanceof L)return me(e.op,e.expression);if(e instanceof _)return me(e.leftExpression,e.op,e.rightExpression);if(e instanceof y)return me(e.expression,e.op);if(e instanceof g)return me(e.value);if(e instanceof A)return me(e.callee,...e.args);if(e instanceof w)return me(e.blockOpenBrace,...e.body,e.blockCloseBrace);if(e instanceof C)return me(e.listOpenBracket,...te(e.elementList,e.commaList),e.listCloseBracket);if(e instanceof k)return me(e.tupleOpenParen,...te(e.elementList,e.commaList),e.tupleCloseParen);if(e instanceof x)return me(e.callee,e.argumentList);if(e instanceof R)return me(e.expression);if(e instanceof U)return me(e.array,e.indexer);throw e instanceof S?new Error("This case is already handled by TupleExpressionNode"):new Error("Unreachable - no other possible cases")}function be(e){return Ie(e)?new F(e.expression.variable):new B}function ve(e){var t;return e instanceof R&&(e.expression instanceof D&&e.expression.variable instanceof c&&e.expression.variable.kind===r.QUOTED_STRING||e.expression instanceof O&&(null==(t=e.expression.literal)?void 0:t.kind)===r.STRING_LITERAL)}function Ie(e){return e instanceof R&&e.expression instanceof D&&e.expression.variable instanceof c}function Le(e){var t;return e instanceof R&&e.expression instanceof D&&(null==(t=e.expression.variable)?void 0:t.kind)===r.IDENTIFIER}function _e(e){var t;return e instanceof _&&e.leftExpression instanceof N&&e.rightExpression instanceof N&&"."===(null==(t=e.op)?void 0:t.value)}function ye(e){if(void 0===e)return new B;const t=e.identifiers.map((e=>e.value)).join(" ");return""===t?new B:new F(t)}class ge{constructor(e){this.start={offset:0,line:0,column:0},this.current={offset:0,line:0,column:0},this.tokens=[],this.errors=[],this.text=e}isAtEnd(){return this.current.offset>=this.text.length}advance(){const e=this.peek();return this.current={...this.current},"\n"===e?(this.current.line+=1,this.current.column=0):this.current.column+=1,this.current.offset+=1,e}peek(e=0){if(!(this.current.offset+e>=this.text.length))return this.text[this.current.offset+e]}check(e){for(let t=0;t<e.length;t+=1)if(e[t]!==this.peek(t))return!1;return!0}match(e){return!!this.check(e)&&(e.split("").forEach((()=>this.advance())),!0)}addToken(e,t=!1){this.tokens.push(this.createToken(e,t))}createToken(e,t=!1){return c.create(e,this.start,this.current,this.text.substring(this.start.offset,this.current.offset),t)}lex(){return this.scanTokens(),this.tokens.push(c.create(r.EOF,this.start,this.current,"",!1)),this.gatherTrivia(),this.gatherInvalid(),new pe(this.tokens,this.errors)}scanTokens(){for(;!this.isAtEnd();){const e=this.advance();switch(e){case" ":this.addToken(r.SPACE);break;case"\r":break;case"\n":this.addToken(r.NEWLINE);break;case"\t":this.addToken(r.TAB);break;case",":this.addToken(r.COMMA);break;case"(":this.addToken(r.LPAREN);break;case")":this.addToken(r.RPAREN);break;case"[":this.addToken(r.LBRACKET);break;case"]":this.addToken(r.RBRACKET);break;case"{":this.addToken(r.LBRACE);break;case"}":this.addToken(r.RBRACE);break;case";":this.addToken(r.SEMICOLON);break;case":":this.addToken(r.COLON);break;case"'":this.match("''")?this.multilineStringLiteral():this.singleLineStringLiteral();break;case'"':this.quotedVariable();break;case"`":this.functionExpression();break;case"#":this.colorLiteral();break;case"/":this.match("/")?this.singleLineComment():this.match("*")?this.multilineComment():this.operator();break;default:if(o(e)){this.operator();break}if(H(e)){this.identifier();break}if(J(e)){this.numericLiteralOrIdentifier();break}this.addToken(r.OP,!0),this.errors.push(new de(he.UNKNOWN_SYMBOL,`Unexpected token '${e}'`,this.createToken(r.OP,!0)))}this.start={...this.current}}}gatherTrivia(){let e,t=!0,n=[];const s=[];for(const i of this.tokens)a(i)?(n.push(i),i.kind===r.NEWLINE&&e&&(e.trailingTrivia=n,t=!0,e=void 0,n=[])):(t?i.leadingTrivia=n:e.trailingTrivia=n,s.push(i),n=[],e=i,t=!1);this.tokens=s}gatherInvalid(){let e;const t=[],n=[];for(e=0;e<this.tokens.length&&Ne(this.tokens[e]);e+=1)n.push(this.tokens[e]);let s=this.tokens[e];for(s.leadingInvalid=[...n,...s.leadingInvalid];e<this.tokens.length;e+=1){const n=this.tokens[e];n.isInvalid?s.trailingInvalid.push(n):(s=n,t.push(n))}this.tokens=t}consumeUntil(e,t,{allowNewline:n,allowEof:s,raw:i,consumeStopSequence:r=!0}){let a="";for(;!this.isAtEnd()&&(n||!this.check("\n"))&&!this.check(t);)"\\"!==this.peek()||i?a+=this.advance():(this.advance(),a+=this.escapedString());if(this.isAtEnd()&&!s){const t=this.createToken(e,!0);return this.tokens.push(t),void this.errors.push(new de(he.UNEXPECTED_EOF,"EOF reached while parsing",t))}if(this.check("\n")&&!n){const t=this.createToken(e,!0);return this.tokens.push(t),void this.errors.push(new de(he.UNEXPECTED_NEWLINE,"Invalid newline encountered while parsing",t))}r&&this.match(t),this.tokens.push(c.create(e,this.start,this.current,a,!1))}singleLineStringLiteral(){this.consumeUntil(r.STRING_LITERAL,"'",{allowNewline:!1,allowEof:!1,raw:!1})}multilineStringLiteral(){this.consumeUntil(r.STRING_LITERAL,"'''",{allowNewline:!0,allowEof:!1,raw:!1})}functionExpression(){this.consumeUntil(r.FUNCTION_EXPRESSION,"`",{allowNewline:!1,allowEof:!1,raw:!0})}quotedVariable(){this.consumeUntil(r.QUOTED_STRING,'"',{allowNewline:!1,allowEof:!1,raw:!1})}singleLineComment(){this.consumeUntil(r.SINGLE_LINE_COMMENT,"\n",{allowNewline:!0,allowEof:!0,raw:!0,consumeStopSequence:!1})}multilineComment(){this.consumeUntil(r.MULTILINE_COMMENT,"*/",{allowNewline:!0,allowEof:!1,raw:!0})}identifier(){for(;!this.isAtEnd()&&ee(this.peek());)this.advance();this.addToken(r.IDENTIFIER)}operator(){for(;o(this.peek());)this.advance();this.addToken(r.OP)}numericLiteralOrIdentifier(){let e=0;if(this.isAtEnd())return this.addToken(r.NUMERIC_LITERAL);for(;!this.isAtEnd();){const t=this.check(".");if(e+=t?1:0,e>1)break;if(!t&&this.current.offset===this.text.length-1)return this.advance(),this.addToken(r.NUMERIC_LITERAL);if(!t&&!ee(this.peek()))return this.addToken(r.NUMERIC_LITERAL);if(!t&&!J(this.peek()))break;this.advance()}if(e>0){for(;!this.isAtEnd()&&(this.check(".")||ee(this.peek()));)this.advance();const e=this.createToken(r.NUMERIC_LITERAL,!0);this.tokens.push(e),this.errors.push(new de(he.UNKNOWN_TOKEN,"Invalid number",e))}else{for(;!this.isAtEnd()&&ee(this.peek());)this.advance();const e=this.createToken(r.IDENTIFIER,!1);this.tokens.push(e)}}colorLiteral(){for(;!this.isAtEnd()&&ee(this.peek());)this.advance();this.addToken(r.COLOR_LITERAL)}escapedString(){const e={column:this.current.column-1,offset:this.current.offset-1,line:this.current.line};if(this.isAtEnd())return"\\";switch(this.advance()){case"\r":return this.check("\n")&&this.advance(),"";case"\n":return"";case"t":return"\t";case"n":return"\n";case"\\":return"\\";case"r":return"\r";case"'":return"'";case'"':return'"';case"0":return"\0";case"b":return"\b";case"v":return"\v";case"f":return"\f";case" ":return"\\ ";case"u":{let t="";for(let n=0;n<=3;n+=1){if(this.isAtEnd()||!ee(this.peek()))return this.errors.push(new de(he.INVALID_ESCAPE_SEQUENCE,`Invalid unicode escape sequence '\\u${t}', only unicode escape sequences of the form '\\uHHHH' where H is a hexadecimal number are allowed`,c.create(r.STRING_LITERAL,e,this.current,`\\u${t}`,!0))),`\\u${t}`;t+=this.advance()}return String.fromCharCode(parseInt(t,16))}default:return this.text[this.current.offset-1]}}}var Ae=(e=>(e[e.ListExpression=0]="ListExpression",e[e.GroupExpression=1]="GroupExpression",e[e.BlockExpression=2]="BlockExpression",e))(Ae||{});class we{constructor(){this.stack=[],this.numberOfNestedLParens=0,this.numberOfNestedLBrackets=0,this.numberOfNestedLBraces=0}push(e){this.stack.push(e),0===e&&(this.numberOfNestedLBrackets+=1),1===e&&(this.numberOfNestedLParens+=1),2===e&&(this.numberOfNestedLBraces+=1)}pop(){const e=this.stack.pop();return 0===e&&(this.numberOfNestedLBrackets-=1),1===e&&(this.numberOfNestedLParens-=1),2===e&&(this.numberOfNestedLBraces-=1),e}top(){return s.last(this.stack)}isWithinGroupExpressionContext(){return this.numberOfNestedLParens>0}isWithinListExpressionContext(){return this.numberOfNestedLBrackets>0}isWithinBlockExpressionContext(){return this.numberOfNestedLBraces>0}withContextDo(e,t){return()=>{this.push(e);try{return t()}finally{this.pop()}}}findHandlerContext(e,t){if(!(this.numberOfNestedLBraces<=0&&this.numberOfNestedLBrackets<=0&&this.numberOfNestedLParens<=0))for(let n=t;n<e.length-1;n+=1)switch(e[n].kind){case r.COMMA:if(this.isWithinGroupExpressionContext()||this.isWithinListExpressionContext())return[...this.stack].reverse().find((e=>[1,0].includes(e)));break;case r.RPAREN:if(this.isWithinGroupExpressionContext())return 1;break;case r.RBRACE:if(this.isWithinBlockExpressionContext())return 2;break;case r.RBRACKET:if(this.isWithinListExpressionContext())return 0}}}class Ce{constructor(e){this.generator=e}create(e,t){return new e(t,this.generator.nextId())}}class ke{constructor(e,t,n){this.token=e,this.partialNode=t,this.handlerContext=n}}class Se{constructor(e,t){this.current=0,this.errors=[],this.contextStack=new we,this.synchronizeProgram=()=>{const e=this.peek();e.kind!==r.EOF?fe(this.advance()):(fe(this.peek()),this.logError(e,he.UNEXPECTED_EOF,"Unexpected EOF"))},this.synchronizeElementDeclarationName=()=>{for(;!this.isAtEnd();){const e=this.peek();if(Ee(e)||this.check(r.COLON,r.LBRACE,r.LBRACKET))break;fe(e),this.advance()}},this.synchronizeElementDeclarationAlias=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(r.COLON,r.LBRACE,r.LBRACKET))break;fe(e),this.advance()}},this.blockExpression=this.contextStack.withContextDo(Ae.BlockExpression,(()=>{const e={body:[]},t=()=>this.nodeFactory.create(w,e);try{this.consume("Expect an opening brace '{'",r.LBRACE),e.blockOpenBrace=this.previous()}catch(n){if(!(n instanceof ke))throw n;if(e.blockOpenBrace=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeBlock()}for(;!this.isAtEnd()&&!this.check(r.RBRACE);)try{e.body.push(this.canBeField()?this.fieldDeclaration():this.expression())}catch(n){if(!(n instanceof ke))throw n;if(e.body.push(n.partialNode),!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeBlock()}try{this.consume("Expect a closing brace '}'",r.RBRACE),e.blockCloseBrace=this.previous()}catch(n){if(!(n instanceof ke))throw n;if(e.blockCloseBrace=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeBlock()}return t()})),this.synchronizeBlock=()=>{if(!this.check(r.RBRACE))for(fe(this.advance());!this.isAtEnd();){const e=this.peek();if(this.check(r.RBRACE)||h(this.previous(),e))break;fe(e),this.advance()}},this.tupleExpression=this.contextStack.withContextDo(Ae.GroupExpression,(()=>{const e={elementList:[],commaList:[]},t=()=>this.nodeFactory.create(S,{groupOpenParen:e.tupleOpenParen,groupCloseParen:e.tupleCloseParen,expression:e.elementList[0]}),n=()=>this.nodeFactory.create(k,e);try{this.consume("Expect an opening parenthesis '('",r.LPAREN),e.tupleOpenParen=this.previous()}catch(t){if(!(t instanceof ke))throw t;if(e.tupleOpenParen=t.partialNode,!this.canHandle(t))throw new ke(t.token,n(),t.handlerContext);this.synchronizeTuple()}if(!this.isAtEnd()&&!this.check(r.RPAREN))try{e.elementList.push(this.normalExpression())}catch(n){if(!(n instanceof ke))throw n;if(e.elementList.push(n.partialNode),!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeTuple()}for(;!this.isAtEnd()&&!this.check(r.RPAREN);)try{this.consume("Expect a comma ','",r.COMMA),e.commaList.push(this.previous()),e.elementList.push(this.normalExpression())}catch(t){if(!(t instanceof ke))throw t;if(t.partialNode instanceof N&&e.elementList.push(t.partialNode),!this.canHandle(t))throw new ke(t.token,n(),t.handlerContext);this.synchronizeTuple()}try{this.consume("Expect a closing parenthesis ')'",r.RPAREN),e.tupleCloseParen=this.previous()}catch(t){if(!(t instanceof ke))throw t;if(e.tupleCloseParen=t.partialNode,!this.canHandle(t))throw new ke(t.token,n(),t.handlerContext);this.synchronizeTuple()}return 1===e.elementList.length?t():n()})),this.synchronizeTuple=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(r.RPAREN,r.COMMA))break;fe(e),this.advance()}},this.listExpression=this.contextStack.withContextDo(Ae.ListExpression,(()=>{const e={elementList:[],commaList:[]},t=()=>this.nodeFactory.create(C,e);try{this.consume("Expect an opening bracket '['",r.LBRACKET),e.listOpenBracket=this.previous()}catch(n){if(!(n instanceof ke))throw n;if(e.listOpenBracket=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeList()}if(!this.isAtEnd()&&!this.check(r.RBRACKET))try{e.elementList.push(this.attribute())}catch(n){if(!(n instanceof ke))throw n;if(e.elementList.push(n.partialNode),!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeList()}for(;!this.isAtEnd()&&!this.check(r.RBRACKET);)try{this.consume("Expect a comma ','",r.COMMA),e.commaList.push(this.previous()),e.elementList.push(this.attribute())}catch(n){if(!(n instanceof ke))throw n;if(n.partialNode instanceof N&&e.elementList.push(n.partialNode),!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeList()}try{this.consume("Expect a closing bracket ']'",r.RBRACKET),e.listCloseBracket=this.previous()}catch(n){if(!(n instanceof ke))throw n;if(e.listCloseBracket=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeList()}return t()})),this.synchronizeList=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(r.COMMA,r.RBRACKET))break;fe(e),this.advance()}},this.synchronizeAttributeName=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(r.COMMA,r.RBRACKET,r.COLON))break;fe(e),this.advance()}},this.synchronizeAttributeValue=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(r.COMMA,r.RBRACKET))break;fe(e),this.advance()}},this.tokens=e,this.nodeFactory=new Ce(t)}isAtEnd(){return this.current>=this.tokens.length||this.tokens[this.current].kind===r.EOF}advance(){return this.isAtEnd()?s.last(this.tokens):this.tokens[this.current++]}peek(e=0){return e+this.current>=this.tokens.length?s.last(this.tokens):this.tokens[this.current+e]}match(...e){const t=this.check(...e);return t&&this.advance(),t}check(...e){const t=this.peek();return e.includes(t.kind)}previous(){return this.tokens[this.current-1]}canHandle(e){return void 0===e.handlerContext||e.handlerContext===this.contextStack.top()}consume(e,...t){if(!this.match(...t))throw this.logError(this.peek(),he.UNEXPECTED_TOKEN,e),new ke(this.peek(),void 0,this.contextStack.findHandlerContext(this.tokens,this.current))}discardUntil(e,...t){if(this.isAtEnd()||!this.check(...t)){for(fe(this.peek()),this.logError(this.advance(),he.UNEXPECTED_TOKEN,e);!this.isAtEnd()&&!this.check(...t);)fe(this.advance());return!this.isAtEnd()}return!0}gatherInvalid(){const e=[],t=[];let n,s=0;for(;s<this.tokens.length&&this.tokens[s].isInvalid;s+=1)t.push(this.tokens[s]);for(n=this.tokens[s],n.leadingInvalid=t,e.push(n),s+=1;s<this.tokens.length;s+=1){const t=this.tokens[s];t.isInvalid?n.trailingInvalid.push(t):(n=t,e.push(n))}this.tokens=e}parse(){const e=this.program(),t=this.advance(),n=this.nodeFactory.create(T,{body:e,eof:t});return this.gatherInvalid(),new pe({ast:n,tokens:this.tokens},this.errors)}program(){const e=[];for(;!this.isAtEnd();)try{const t=this.elementDeclaration();e.push(t)}catch(t){if(!(t instanceof ke))throw t;e.push(t.partialNode),this.synchronizeProgram()}return e}elementDeclaration(){const e={},t=()=>this.nodeFactory.create(b,e);try{this.consume("Expect an identifier",r.IDENTIFIER),e.type=this.previous()}catch(n){throw n instanceof ke?(e.type=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}if(!this.check(r.COLON,r.LBRACE,r.LBRACKET))try{e.name=this.normalExpression()}catch(n){if(!(n instanceof ke))throw n;if(e.name=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeElementDeclarationName()}if(Ee(this.peek()))if(e.as=this.advance(),this.check(r.COLON,r.LBRACE,r.LBRACKET))this.logError(this.peek(),he.UNEXPECTED_TOKEN,"Expect an alias");else try{e.alias=this.normalExpression()}catch(n){if(!(n instanceof ke))throw n;if(e.alias=n.partialNode,!this.canHandle(n))throw new ke(n.token,t(),n.handlerContext);this.synchronizeElementDeclarationAlias()}try{e.attributeList=this.check(r.LBRACKET)?this.listExpression():void 0}catch(n){throw n instanceof ke?(e.attributeList=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}if(!this.discardUntil("Expect an opening brace '{' or a colon ':'",r.LBRACE,r.COLON))return t();try{if(this.match(r.COLON)){e.bodyColon=this.previous();const t=this.expression();t instanceof b?(fe(t),this.logError(t,he.UNEXPECTED_ELEMENT_DECLARATION,"An element's simple body must not be an element declaration")):e.body=t}else e.body=this.blockExpression()}catch(n){throw n instanceof ke?(e.body=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}return this.nodeFactory.create(b,e)}fieldDeclaration(){const e={},t=()=>this.nodeFactory.create(b,e);try{this.consume("Expect an identifier",r.IDENTIFIER),e.type=this.previous()}catch(n){throw n instanceof ke?(e.type=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}try{this.consume("Expect a colon ':'",r.COLON),e.bodyColon=this.previous()}catch(n){throw n instanceof ke?(e.bodyColon=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}try{const t=this.expression();t instanceof b?this.errors.push(new de(he.INVALID_ELEMENT_IN_SIMPLE_BODY,"Simple body cannot be an element declaration",t)):e.body=t}catch(n){throw n instanceof ke?(e.body=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}return this.nodeFactory.create(b,e)}expression(){const e={args:[]},t=()=>function(e,t,n){if(!e||!Le(e)||0===t.length)return new B;const i=[...t],r=be(e).unwrap(),a=i.pop();if(!(a instanceof w))return new B;const o=s.last(i)instanceof C?i.pop():void 0;return 3===i.length&&"as"===be(i[1]).unwrap().value?new F(n.create(b,{type:r,name:i[0],as:be(i[1]).unwrap(),alias:i[2],attributeList:o,body:a})):1===i.length?new F(n.create(b,{type:r,name:i[0],attributeList:o,body:a})):0===i.length?new F(n.create(b,{type:r,attributeList:o,body:a})):new B}(e.callee,e.args,this.nodeFactory).unwrap_or(this.nodeFactory.create(A,e));try{e.callee=this.normalExpression()}catch(n){throw n instanceof ke?(e.callee=n.partialNode,new ke(n.token,t(),n.handlerContext)):n}if(this.shouldStopExpression())return t();let n=e.callee;for(;!this.shouldStopExpression();){d(this.previous())||this.logError(n,he.MISSING_SPACES,"Expect a following space");try{n=this.normalExpression(),e.args.push(n)}catch(s){throw s instanceof ke?(n=s.partialNode,e.args.push(n),new ke(s.token,t(),s.handlerContext)):s}}return t()}shouldStopExpression(){if(this.isAtEnd()||u(this.previous()))return!0;const e=this.peek().kind;return e===r.RBRACE||e===r.RBRACKET||e===r.RPAREN||e===r.COMMA||e===r.COLON}normalExpression(){return this.expression_bp(0)}expression_bp(e){let t=this.leftExpression_bp();for(;!this.isAtEnd();){const n=this.peek();if(n.kind===r.LPAREN){const{left:s}=Pe(n);if(s<e||h(this.previous(),n)&&!this.contextStack.isWithinGroupExpressionContext()&&!this.contextStack.isWithinListExpressionContext())break;try{t=this.nodeFactory.create(x,{callee:t,argumentList:this.tupleExpression()})}catch(e){throw e instanceof ke?(t=this.nodeFactory.create(x,{callee:t,argumentList:e.partialNode}),new ke(e.token,t,e.handlerContext)):e}}else if(n.kind===r.LBRACKET){if(d(this.previous()))break;try{t=this.nodeFactory.create(U,{expression:t,indexer:this.listExpression()})}catch(e){throw e instanceof ke?(t=this.nodeFactory.create(U,{expression:t,indexer:e.partialNode}),new ke(e.token,t,e.handlerContext)):e}}else{if(!l(n))break;{const s=n,i=Pe(s);if(null!==i.left){if(i.left<=e)break;this.advance(),t=this.nodeFactory.create(y,{expression:t,op:s})}else{const n=Oe(s);if(null===n.left||n.left<=e)break;this.advance();try{t=this.nodeFactory.create(_,{leftExpression:t,op:s,rightExpression:"."===s.value?this.extractOperand():this.expression_bp(n.right)})}catch(e){throw e instanceof ke?(t=this.nodeFactory.create(_,{leftExpression:t,op:s,rightExpression:e.partialNode}),new ke(e.token,t,e.handlerContext)):e}}}}}return t}leftExpression_bp(){let e;if(l(this.peek())){const t={};t.op=this.peek();const n=function(e){return De[e.value]||{left:null,right:null}}(t.op);if(null===n.right)throw this.logError(t.op,he.UNKNOWN_PREFIX_OP,`Unexpected '${t.op.value}' in an expression`),new ke(t.op,this.nodeFactory.create(P,{pre:t.op}),this.contextStack.findHandlerContext(this.tokens,this.current));this.advance();try{t.expression=this.expression_bp(n.right)}catch(e){throw e instanceof ke?(t.expression=e.partialNode,new ke(e.token,this.nodeFactory.create(L,t),e.handlerContext)):e}e=this.nodeFactory.create(L,t)}else if(e=this.extractOperand(),e instanceof P)throw new ke(this.peek(),this.nodeFactory.create(P,{pre:this.peek()}),this.contextStack.findHandlerContext(this.tokens,this.current));return e}extractOperand(){return this.check(r.NUMERIC_LITERAL,r.STRING_LITERAL,r.COLOR_LITERAL,r.QUOTED_STRING,r.IDENTIFIER)?this.primaryExpression():this.check(r.FUNCTION_EXPRESSION)?this.functionExpression():this.check(r.LBRACKET)?this.listExpression():this.check(r.LBRACE)?this.blockExpression():this.check(r.LPAREN)?this.tupleExpression():(this.peek().kind===r.EOF?this.logError(this.peek(),he.UNEXPECTED_EOF,"Unexpected EOF"):this.logError(this.peek(),he.INVALID_OPERAND,`Invalid start of operand "${this.peek().value}"`),this.nodeFactory.create(P,{pre:this.previous()}))}functionExpression(){const e={};try{this.consume("Expect a function expression",r.FUNCTION_EXPRESSION),e.value=this.previous()}catch(t){throw t instanceof ke?(e.value=t.partialNode,new ke(t.token,this.nodeFactory.create(g,e),t.handlerContext)):t}return this.nodeFactory.create(g,e)}canBeField(){return this.peek().kind===r.IDENTIFIER&&this.peek(1).kind===r.COLON}primaryExpression(){if(this.match(r.COLOR_LITERAL,r.STRING_LITERAL,r.NUMERIC_LITERAL))return this.nodeFactory.create(R,{expression:this.nodeFactory.create(O,{literal:this.previous()})});if(this.match(r.QUOTED_STRING,r.IDENTIFIER))return this.nodeFactory.create(R,{expression:this.nodeFactory.create(D,{variable:this.previous()})});throw this.logError(this.peek(),he.UNEXPECTED_TOKEN,"Expect a variable or literal"),new ke(this.peek(),void 0,this.contextStack.findHandlerContext(this.tokens,this.current))}attribute(){const e={};if(this.check(r.COLON,r.RBRACKET,r.COMMA)){const t=this.peek();this.logError(t,he.EMPTY_ATTRIBUTE_NAME,"Expect a non-empty attribute name"),e.name=this.nodeFactory.create(v,{identifiers:[]})}else try{e.name=this.attributeName()}catch(t){if(!(t instanceof ke))throw t;if(e.name=t.partialNode,!this.canHandle(t))throw new ke(t.token,this.nodeFactory.create(I,e),t.handlerContext);this.synchronizeAttributeName()}return this.match(r.COLON)&&(e.colon=this.previous(),e.value=this.attributeValue()),this.nodeFactory.create(I,e)}attributeValue(){let e;try{e=this.peek().kind===r.IDENTIFIER&&this.peek(1).kind===r.IDENTIFIER?this.attributeName():this.normalExpression()}catch(t){if(!(t instanceof ke&&this.canHandle(t)))throw t;e=t.partialNode,this.synchronizeAttributeValue()}return e}attributeName(){const e=[];if(this.peek().kind!==r.IDENTIFIER)return this.primaryExpression();for(;!this.isAtEnd()&&!this.check(r.COLON,r.COMMA,r.RBRACKET);)try{this.consume("Expect an identifier",r.IDENTIFIER),e.push(this.previous())}catch(t){throw t instanceof ke?new ke(t.token,this.nodeFactory.create(v,{identifiers:e}),t.handlerContext):t}return this.nodeFactory.create(v,{identifiers:e})}logError(e,t,n){this.errors.push(new de(t,n,e))}}const xe={"+":{left:9,right:10},"*":{left:11,right:12},"-":{left:9,right:10},"/":{left:11,right:12},"%":{left:11,right:12},"<":{left:7,right:8},"<=":{left:7,right:8},">":{left:7,right:8},">=":{left:7,right:8},"<>":{left:7,right:8},"=":{left:2,right:3},"==":{left:4,right:5},"!=":{left:4,right:5},".":{left:16,right:17}};function Oe(e){return xe[e.value]||{left:null,right:null}}const De={"+":{left:null,right:15},"-":{left:null,right:15},"<":{left:null,right:15},">":{left:null,right:15},"<>":{left:null,right:15},"!":{left:null,right:15}};const Re={"(":{left:14,right:null}};function Pe(e){return Re[e.value]||{left:null,right:null}}var Ue=(e=>(e.Table="table",e.Enum="enum",e.Ref="ref",e.Note="note",e.Project="project",e.Indexes="indexes",e.TableGroup="tablegroup",e))(Ue||{});function Me(e){var t;const n=null==(t=null==e?void 0:e.type)?void 0:t.value.toLowerCase();switch(n){case Ue.Enum:case Ue.Table:case Ue.Indexes:case Ue.Note:case Ue.Project:case Ue.Ref:case Ue.TableGroup:return new F(n);default:return new B}}function Fe(e){if(!_e(e))return new F([e]);const t=Fe(e.leftExpression).unwrap_or(void 0);return t?(t.push(e.rightExpression),new F(t)):new B}function Be(e){if(void 0===e)return new B;const t=Fe(e).unwrap_or(void 0);if(!t)return new B;const n=[];for(const e of t){const t=Ve(e).unwrap_or(void 0);if(!t)return new B;n.push(t)}return new F(n)}function Ge(e){if(void 0===e)return new B;const t=Fe(e).unwrap_or(void 0);if(!t||0===t.length)return new B;const n=[];let i;if(!Ie(s.last(t))){const e=t.pop();if(!Et(e))return new B;i=e.elementList.map((e=>Ke(e).unwrap()))}for(const e of t){const t=Ve(e).unwrap_or(void 0);if(!t)return new B;n.push(t)}return new F({variables:n,tupleElements:i})}function Ve(e){return Ie(e)?new F(e.expression.variable.value):new B}function Xe(e){if(We(e))return new F(e instanceof g?{functional:[e],nonFunctional:[]}:{functional:[],nonFunctional:[e]});if(e instanceof k&&e.elementList.every(We)){const t=e.elementList.filter((e=>e instanceof g)),n=e.elementList.filter(Ie);return new F({functional:t,nonFunctional:n})}return new B}function Ke(e){var t;const n=null==(t=null==e?void 0:e.expression.variable)?void 0:t.value;return void 0===n?new B:new F(n)}function $e(e){return ve(e)?e.expression instanceof D?new F(e.expression.variable.value):new F(e.expression.literal.value):new B}function We(e){return e instanceof R&&e.expression instanceof D||e instanceof g}function je(e,t){var n,s,i,r;let a=t;const o=function(e){const t=z(e).unwrap_or(void 0);if(!t)return!1;const{kind:n,name:s}=t;return"Schema"===n&&"public"===s}(e);for(;a;){if(null!=(s=null==(n=a.symbol)?void 0:n.symbolTable)&&s.has(e))return null==(i=a.symbol.symbolTable)?void 0:i.get(e);if((null==(r=a.symbol)?void 0:r.declaration)instanceof T&&o)return a.symbol;if(a instanceof T)return;a=a.parent}}class Ye{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T||Me(this.declarationNode.parent).unwrap_or(void 0)!==Ue.Project?[new de(he.INVALID_CUSTOM_CONTEXT,"A custom element can only appear in a Project",this.declarationNode)]:[]}validateName(e){return e?[new de(he.UNEXPECTED_NAME,"A Custom element shouldn't have a name",e)]:[]}validateAlias(e){return e?[new de(he.UNEXPECTED_NAME,"A Custom element shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"A Custom element shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof w)return[new de(he.UNEXPECTED_COMPLEX_BODY,"A Custom element can only have an inline field",e)];const t=[];return ve(e.callee)||t.push(new de(he.INVALID_CUSTOM_ELEMENT_VALUE,"A Custom element value can only be a string",e)),e.args.length>0&&t.push(...e.args.map((e=>new de(he.INVALID_CUSTOM_ELEMENT_VALUE,"A Custom element value can only be a string",e)))),t}}class qe{constructor(){this.table=new Map}has(e){return this.table.has(e)}set(e,t){this.table.set(e,t)}get(e,t){return this.table.get(e)||void 0!==t&&this.set(e,t)||t}entries(){return this.table.entries()}}class ze{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new de(he.INVALID_PROJECT_CONTEXT,"An Enum can only appear top-level",this.declarationNode)]:[]}validateName(e){return e?rt(e)?[]:[new de(he.INVALID_NAME,"An Enum name must be of the form <enum> or <schema>.<enum>",e)]:[new de(he.NAME_NOT_FOUND,"An Enum must have a name",this.declarationNode)]}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}registerElement(){const e=[];this.declarationNode.symbol=this.symbolFactory.create(re,{declaration:this.declarationNode,symbolTable:new qe});const{name:t}=this.declarationNode,n=Be(t);if(n.isOk()){const s=n.unwrap(),i=s.pop(),r=ot(s,this.publicSymbolTable,this.symbolFactory),a=$(i);r.has(a)&&e.push(new de(he.DUPLICATE_NAME,`Enum name ${i} already exists in schema '${s.join(".")||"public"}'`,t)),r.set(a,this.declarationNode.symbol)}return e}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"An Enum shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof A)return this.validateFields([e]);const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return 0===e.length?[new de(he.EMPTY_ENUM,"An Enum must have at least one element",this.declarationNode)]:e.flatMap((e=>{const t=[];e.callee&&!Ie(e.callee)&&t.push(new de(he.INVALID_ENUM_ELEMENT_NAME,"An enum field must be an identifier or a quoted identifier",e.callee));const n=[...e.args];return s.last(n)instanceof C?(t.push(...this.validateFieldSettings(s.last(n))),n.pop()):n[0]instanceof C&&(t.push(...this.validateFieldSettings(n[0])),n.shift()),n.length>0&&t.push(...n.map((e=>new de(he.INVALID_ENUM_ELEMENT,"An Enum must have only a field and optionally a setting list",e)))),t.push(...this.registerField(e)),t}))}validateFieldSettings(e){const t=ft(e),n=t.getErrors(),s=t.getValue();for(const e in s){const t=s[e];if("note"===e)t.length>1&&t.forEach((e=>n.push(new de(he.DUPLICATE_ENUM_ELEMENT_SETTING,"'note' can only appear once",e)))),t.forEach((e=>{ve(e.value)||n.push(new de(he.INVALID_ENUM_ELEMENT_SETTING,"'note' must be a string",e))}));else t.forEach((t=>n.push(new de(he.UNKNOWN_ENUM_ELEMENT_SETTING,`Unknown enum field setting '${e}'`,t))))}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}registerField(e){if(e.callee&&Ie(e.callee)){const t=Ke(e.callee).unwrap(),n=W(t),s=this.symbolFactory.create(ae,{declaration:e});e.symbol=s;const i=this.declarationNode.symbol.symbolTable;if(i.has(n)){const s=i.get(n);return[new de(he.DUPLICATE_COLUMN_NAME,`Duplicate enum field ${t}`,e),new de(he.DUPLICATE_COLUMN_NAME,`Duplicate enum field ${t}`,s.declaration)]}i.set(n,s)}return[]}}class Qe{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T||Me(this.declarationNode.parent).unwrap_or(void 0)!==Ue.Table?[new de(he.INVALID_NOTE_CONTEXT,"An Indexes can only appear inside a Table",this.declarationNode)]:[]}validateName(e){return e?[new de(he.UNEXPECTED_NAME,"An Indexes shouldn't have a name",e)]:[]}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"An Indexes shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"An Indexes shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof A)return[new de(he.UNEXPECTED_SIMPLE_BODY,"An Indexes must have a complex body",e)];const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return e.flatMap((e=>{if(!e.callee)return[];const t=[],n=[e.callee,...e.args];return s.last(n)instanceof C&&t.push(...this.validateFieldSetting(n.pop())),n.forEach((e=>{for(;e instanceof x;)e.argumentList&&!Xe(e.argumentList).isOk()&&t.push(new de(he.INVALID_INDEXES_FIELD,"An index field must be an identifier, a quoted identifier, a functional expression or a tuple of such",e.argumentList)),e=e.callee;Xe(e).isOk()||t.push(new de(he.INVALID_INDEXES_FIELD,"An index field must be an identifier, a quoted identifier, a functional expression or a tuple of such",e))})),t}))}validateFieldSetting(e){const t=ft(e),n=t.getErrors(),s=t.getValue();for(const e in s){const t=s[e];switch(e){case"note":case"name":t.length>1&&t.forEach((t=>n.push(new de(he.DUPLICATE_INDEX_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{ve(t.value)||n.push(new de(he.INVALID_INDEX_SETTING_VALUE,`'${e}' must be a string`,t))}));break;case"unique":case"pk":t.length>1&&t.forEach((t=>n.push(new de(he.DUPLICATE_INDEX_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{ut(t.value)||n.push(new de(he.INVALID_INDEX_SETTING_VALUE,`'${e}' must not have a value`,t))}));break;case"type":t.length>1&&t.forEach((e=>n.push(new de(he.DUPLICATE_INDEX_SETTING,"'type' can only appear once",e)))),t.forEach((e=>{Ie(e.value)||n.push(new de(he.INVALID_INDEX_SETTING_VALUE,'\'type\' must be "btree" or "hash"',e))}));break;default:t.forEach((t=>n.push(new de(he.UNKNOWN_INDEX_SETTING,`Unknown index setting '${e}'`,t))))}}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class He{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T||[Ue.Table,Ue.TableGroup,Ue.Project].includes(Me(this.declarationNode.parent).unwrap_or(void 0))?[]:[new de(he.INVALID_NOTE_CONTEXT,"A Note can only appear inside a Table, a Table Group or a Project. Sticky note can only appear at the global scope.",this.declarationNode)]}validateName(e){if(!(this.declarationNode.parent instanceof T))return e?[new de(he.UNEXPECTED_NAME,"A Note shouldn't have a name",e)]:[];if(!e)return[new de(he.INVALID_NAME,"Sticky note must have a name",this.declarationNode)];const t=Be(e);if(!t.isOk())return[new de(he.INVALID_NAME,"Invalid name for sticky note ",this.declarationNode)];const n=t.unwrap().join("."),s=function(e){return`Note:${e}`}(n);return this.publicSymbolTable.has(s)?[new de(he.DUPLICATE_NAME,`Sticky note "${n}" has already been defined`,e)]:(this.publicSymbolTable.set(s,this.declarationNode.symbol),[])}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"A Note shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof A)return this.validateFields([e]);const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){const t=[];return 0===e.length?[new de(he.EMPTY_NOTE,"A Note must have a content",this.declarationNode)]:(e.length>1&&e.slice(1).forEach((e=>t.push(new de(he.NOTE_CONTENT_REDEFINED,"A Note can only contain one string",e)))),ve(e[0].callee)||t.push(new de(he.INVALID_NOTE,"A Note content must be a quoted string",e[0])),e[0].args.length>0&&t.push(...e[0].args.map((e=>new de(he.INVALID_NOTE,"A Note can only contain one quoted string",e)))),t)}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class Je{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new de(he.INVALID_PROJECT_CONTEXT,"A Project can only appear top-level",this.declarationNode)]:[]}validateName(e){return e?at(e)?[]:[new de(he.INVALID_NAME,"A Project's name is optional or must be an identifier or a quoted identifer",e)]:[]}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"A Project shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"A Project shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof A)return[new de(he.UNEXPECTED_SIMPLE_BODY,"A Project's body must be a block",e)];const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...t.map((e=>new de(he.INVALID_PROJECT_FIELD,"A Project can not have inline fields",e))),...this.validateSubElements(n)]}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class Ze{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T?[]:[new de(he.INVALID_REF_CONTEXT,"A Ref must appear top-level",this.declarationNode)]}validateName(e){return e?at(e)?[]:[new de(he.INVALID_NAME,"A Ref's name is optional or must be an identifier or a quoted identifer",e)]:[]}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new de(he.UNEXPECTED_SETTINGS,"A Ref shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof A)return this.validateFields([e]);const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){if(0===e.length)return[new de(he.EMPTY_REF,"A Ref must have at least one field",this.declarationNode)];const t=[];return e.length>1&&t.push(...e.slice(1).map((e=>new de(he.REF_REDEFINED,"A Ref can only contain one binary relationship",e)))),e.forEach((e=>{e.callee&&!function(e){var t;return!!(e instanceof _&&lt(null==(t=e.op)?void 0:t.value))&&void 0!==Ge(e.leftExpression).and_then((()=>Ge(e.rightExpression))).unwrap_or(void 0)}(e.callee)&&t.push(new de(he.INVALID_REF_FIELD,"A Ref field must be a binary relationship",e.callee)),e.callee&&!function(e){const t=Ge(e.leftExpression),n=Ge(e.rightExpression);if(!t.isOk()||!n.isOk())return!1;const{tupleElements:s}=t.unwrap(),{tupleElements:i}=n.unwrap();return(null==s?void 0:s.length)===(null==i?void 0:i.length)}(e.callee)&&t.push(new de(he.UNEQUAL_FIELDS_BINARY_REF,"Unequal fields in ref endpoints",e.callee));const n=[...e.args];if(s.last(n)instanceof C){const e=this.validateFieldSettings(s.last(n));t.push(...e),n.pop()}else n[0]instanceof C&&(t.push(...this.validateFieldSettings(n[0])),n.shift());n.length>0&&t.push(...n.map((e=>new de(he.INVALID_REF_FIELD,"A Ref field should only have a single binary relationship",e))))})),t}validateFieldSettings(e){const t=ft(e),n=t.getErrors(),s=t.getValue();for(const e in s){const t=s[e];switch(e){case"delete":case"update":t.length>1&&t.forEach((t=>n.push(new de(he.DUPLICATE_REF_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{et(t.value)||n.push(new de(he.INVALID_REF_SETTING_VALUE,`'${e}' can only have values "cascade", "no action", "set null", "set default" or "restrict"`,t))}));break;case"color":t.length>1&&n.push(...t.map((e=>new de(he.DUPLICATE_REF_SETTING,"'color' can only appear once",e)))),t.forEach((e=>{ct(e.value)||n.push(new de(he.INVALID_REF_SETTING_VALUE,"'color' must be a color literal",e))}));break;default:t.forEach((t=>n.push(new de(he.UNKNOWN_REF_SETTING,`Unknown ref setting '${e}'`,t))))}}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}function et(e){if(!(Ie(e)&&e.expression.variable.kind!==r.QUOTED_STRING||e instanceof v))return!1;let t;if(t=e instanceof v?ye(e).unwrap_or(""):e.expression.variable.value,t)switch(t.toLowerCase()){case"cascade":case"no action":case"set null":case"set default":case"restrict":return!0;default:return!1}return!1}class tt{constructor(e,t,n){this.declarationNode=e,this.symbolFactory=n,this.publicSymbolTable=t}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new de(he.INVALID_TABLE_CONTEXT,"Table must appear top-level",this.declarationNode)]:[]}validateName(e){return e?e instanceof U?[new de(he.INVALID_NAME,"Invalid array as Table name, maybe you forget to add a space between the name and the setting list?",e)]:rt(e)?[]:[new de(he.INVALID_NAME,"A Table name must be of the form <table> or <schema>.<table>",e)]:[new de(he.NAME_NOT_FOUND,"A Table must have a name",this.declarationNode)]}validateAlias(e){return e?function(e){return at(e)}(e)?[]:[new de(he.INVALID_ALIAS,"Table aliases can only contains alphanumeric and underscore unless surrounded by double quotes",e)]:[]}validateSettingList(e){const t=ft(e),n=t.getErrors(),s=t.getValue();for(const e in s){const t=s[e];switch(e){case"headercolor":t.length>1&&n.push(...t.map((e=>new de(he.DUPLICATE_TABLE_SETTING,"'headercolor' can only appear once",e)))),t.forEach((e=>{ct(e.value)||n.push(new de(he.INVALID_TABLE_SETTING,"'headercolor' must be a color literal",e.value||e.name))}));break;case"note":t.length>1&&n.push(...t.map((e=>new de(he.DUPLICATE_TABLE_SETTING,"'note' can only appear once",e)))),t.forEach((e=>{ve(e.value)||n.push(new de(he.INVALID_TABLE_SETTING,"'note' must be a string literal",e.value||e.name))}));break;default:n.push(...t.map((t=>new de(he.INVALID_TABLE_SETTING,`Unknown '${e}' setting`,t))))}}return n}registerElement(){const e=[];this.declarationNode.symbol=this.symbolFactory.create(oe,{declaration:this.declarationNode,symbolTable:new qe});const{name:t,alias:n}=this.declarationNode,s=Be(t);if(s.isOk()){const n=[...s.unwrap()],i=n.pop(),r=ot(n,this.publicSymbolTable,this.symbolFactory),a=X(i);r.has(a)&&e.push(new de(he.DUPLICATE_NAME,`Table name '${i}' already exists in schema '${n.join(".")||"public"}'`,t)),r.set(a,this.declarationNode.symbol)}if(n&&at(n)&&!function(e,t){return 1===t.length&&e===t[0]}(n.expression.variable.value,s.unwrap_or([]))){const s=Ke(n).unwrap(),i=X(s);this.publicSymbolTable.has(i)&&e.push(new de(he.DUPLICATE_NAME,`Table name '${s}' already exists`,t)),this.publicSymbolTable.set(i,this.declarationNode.symbol)}return e}validateBody(e){if(!e)return[];if(e instanceof A)return[new de(he.UNEXPECTED_SIMPLE_BODY,"A Table's body must be a block",e)];const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return 0===e.length?[new de(he.EMPTY_TABLE,"A Table must have at least one column",this.declarationNode)]:e.flatMap((e=>{if(!e.callee)return[];const t=[];0===e.args.length&&t.push(new de(he.INVALID_COLUMN,"A column must have a type",e.callee)),Ie(e.callee)||t.push(new de(he.INVALID_COLUMN_NAME,"A column name must be an identifier or a quoted identifier",e.callee)),e.args[0]&&!function(e){if(!(e instanceof x||_e(e)||e instanceof R||e instanceof U))return!1;if(e instanceof x){if(void 0===e.callee||void 0===e.argumentList||!e.argumentList.elementList.every((e=>dt(e)||ve(e)||Le(e))))return!1;e=e.callee}for(;e instanceof U;){if(void 0===e.array||void 0===e.indexer||!e.indexer.elementList.every((e=>!e.colon&&!e.value&&dt(e.name))))return!1;e=e.array}const t=Be(e).unwrap_or(void 0);return void 0!==t&&t.length>0}(e.args[0])&&t.push(new de(he.INVALID_COLUMN_TYPE,"Invalid column type",e.args[0]));const n=e.args.slice(1);return t.push(...this.validateFieldSetting(n)),t.push(...this.registerField(e)),t}))}registerField(e){if(e.callee&&Ie(e.callee)){const t=Ke(e.callee).unwrap(),n=K(t),s=this.symbolFactory.create(le,{declaration:e});e.symbol=s;const i=this.declarationNode.symbol.symbolTable;if(i.has(n)){const s=i.get(n);return[new de(he.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,e),new de(he.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,s.declaration)]}i.set(n,s)}return[]}validateFieldSetting(e){if(!e.slice(0,-1).every(Le)||!e.slice(-1).every((e=>Le(e)||e instanceof C)))return[...e.map((e=>new de(he.INVALID_COLUMN,"These fields must be some inline settings optionally ended with a setting list",e)))];if(0===e.length)return[];let t;s.last(e)instanceof C&&(t=e.pop());const n=ft(t),i=n.getErrors(),r=n.getValue();for(const t of e){const e=Ke(t).unwrap_or("").toLowerCase();"pk"===e||"unique"===e?void 0===r[e]?r[e]=[t]:r[e].push(t):i.push(new de(he.INVALID_SETTINGS,"Inline column settings can only be `pk` or `unique`",t))}const a=r.pk||[],o=r["primary key"]||[];a.length>=1&&o.length>=1&&i.push(...[...a,...o].map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"Either one of 'primary key' and 'pk' can appear",e))));for(const e in r){const t=r[e];switch(e){case"note":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"note can only appear once",e)))),t.forEach((e=>{ve(e.value)||i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'note' must be a quoted string",e.value||e.name))}));break;case"ref":t.forEach((e=>{pt(e.value)||i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'ref' must be a valid unary relationship",e.value||e.name))}));break;case"primary key":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"primary key can only appear once",e)))),t.forEach((e=>{ut(e.value)||i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'primary key' must not have a value",e.value||e.name))}));break;case"pk":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"'pk' can only appear once",e)))),t.forEach((e=>{e instanceof I&&!ut(e.value)&&i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'pk' must not have a value",e.value||e.name))}));break;case"not null":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"'not null' can only appear once",e))));const n=r.null||[];t.length>=1&&n.length>=1&&i.push(...[...t,...n].map((e=>new de(he.CONFLICTING_SETTING,"'not null' and 'null' can not be set at the same time",e)))),t.forEach((e=>{ut(e.value)||i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'not null' must not have a value",e.value||e.name))}));break;case"null":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"'null' can only appear once",e)))),t.forEach((e=>{ut(e.value)||i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'null' must not have a value",e.value||e.name))}));break;case"unique":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"'unique' can only appear once",e)))),t.forEach((e=>{e instanceof I&&!ut(e.value)&&i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'unique' must not have a value",e.value||e.name))}));break;case"increment":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_COLUMN_SETTING,"'increment' can only appear once",e)))),t.forEach((e=>{e instanceof I&&!ut(e.value)&&i.push(new de(he.INVALID_COLUMN_SETTING_VALUE,"'increment' must not have a value",e.value||e.name))}));break;case"default":t.length>1&&i.push(...t.map((e=>new de(he.DUPLICATE_TABLE_SETTING,"'default' can only appear once",e)))),t.forEach((e=>{ht(e.value)||i.push(new de(he.INVALID_TABLE_SETTING,"'default' must be a string literal, number literal, function expression, true, false or null",e.value||e.name))}));break;default:t.forEach((t=>i.push(new de(he.UNKNOWN_COLUMN_SETTING,`Unknown column setting '${e}'`,t))))}}return i}validateSubElements(e){const t=e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()})),n=e.filter((e=>{var t;return"note"===(null==(t=e.type)?void 0:t.value.toLowerCase())}));return n.length>1&&t.push(...n.map((e=>new de(he.NOTE_REDEFINED,"Duplicate notes are defined",e)))),t}}class nt{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new de(he.INVALID_TABLEGROUP_CONTEXT,"TableGroup must appear top-level",this.declarationNode)]:[]}validateName(e){return e?at(e)?[]:[new de(he.INVALID_NAME,"A TableGroup name must be a single identifier",e)]:[new de(he.NAME_NOT_FOUND,"A TableGroup must have a name",this.declarationNode)]}validateAlias(e){return e?[new de(he.UNEXPECTED_ALIAS,"A TableGroup shouldn't have an alias",e)]:[]}registerElement(){const{name:e}=this.declarationNode;this.declarationNode.symbol=this.symbolFactory.create(ce,{declaration:this.declarationNode,symbolTable:new qe});const t=Be(e);if(t.isOk()){const n=t.unwrap(),s=n.pop(),i=ot(n,this.publicSymbolTable,this.symbolFactory),r=j(s);if(i.has(r))return[new de(he.DUPLICATE_NAME,`TableGroup name '${s}' already exists`,e)];i.set(r,this.declarationNode.symbol)}return[]}validateSettingList(e){const t=ft(e),n=t.getErrors(),i=t.getValue();return s.forIn(i,((e,t)=>{switch(t){case"color":e.length>1&&n.push(...e.map((e=>new de(he.DUPLICATE_TABLE_SETTING,"'color' can only appear once",e)))),e.forEach((e=>{ct(e.value)||n.push(new de(he.INVALID_TABLE_SETTING,"'color' must be a color literal",e.value||e.name))}));break;case"note":e.length>1&&n.push(...e.map((e=>new de(he.DUPLICATE_TABLE_SETTING,"'note' can only appear once",e)))),e.filter((e=>!ve(e.value))).forEach((e=>{n.push(new de(he.INVALID_TABLE_SETTING,"'note' must be a string literal",e.value||e.name))}));break;default:n.push(...e.map((e=>new de(he.INVALID_TABLE_SETTING,`Unknown '${t}' setting`,e))))}})),n}validateBody(e){if(!e)return[];if(e instanceof A)return[new de(he.UNEXPECTED_SIMPLE_BODY,"A TableGroup's body must be a block",e)];const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return e.flatMap((e=>{const t=[];return e.callee&&!Be(e.callee).isOk()&&t.push(new de(he.INVALID_TABLEGROUP_FIELD,"A TableGroup field must be of the form <table> or <schema>.<table>",e.callee)),this.registerField(e),e.args.length>0&&t.push(...e.args.map((e=>new de(he.INVALID_TABLEGROUP_FIELD,"A TableGroup field should only have a single Table name",e)))),t}))}validateSubElements(e){const t=e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(it(e))(e,this.publicSymbolTable,this.symbolFactory).validate()})),n=e.filter((e=>{var t;return"note"===(null==(t=e.type)?void 0:t.value.toLowerCase())}));return n.length>1&&t.push(...n.map((e=>new de(he.NOTE_REDEFINED,"Duplicate notes are defined",e)))),t}registerField(e){if(e.callee&&Ie(e.callee)){const t=Ke(e.callee).unwrap(),n=Y(t),s=this.symbolFactory.create(ue,{declaration:e});e.symbol=s;const i=this.declarationNode.symbol.symbolTable;if(i.has(n)){const s=i.get(n);return[new de(he.DUPLICATE_TABLEGROUP_FIELD_NAME,`${t} already exists in the group`,e),new de(he.DUPLICATE_TABLEGROUP_FIELD_NAME,`${t} already exists in the group`,s.declaration)]}i.set(n,s)}return[]}}const st=["-","+"];function it(e){switch(e.type.value.toLowerCase()){case Ue.Enum:return ze;case Ue.Table:return tt;case Ue.TableGroup:return nt;case Ue.Project:return Je;case Ue.Ref:return Ze;case Ue.Note:return He;case Ue.Indexes:return Qe;default:return Ye}}function rt(e){return!!Be(e).unwrap_or(!1)}function at(e){return e instanceof R&&e.expression instanceof D}function ot(e,t,n){var s;"public"===e[0]&&(e=e.slice(1));let i=t;for(const t of e){let e;const r=V(t);if(i.has(r)){if(e=null==(s=i.get(r))?void 0:s.symbolTable,!e)throw new Error("Expect a symbol table in a schema symbol")}else{e=new qe;const t=n.create(ie,{symbolTable:e});i.set(r,t)}i=e}return i}function lt(e){return"-"===e||"<>"===e||">"===e||"<"===e}function ct(e){var t;if(!(e instanceof R&&e.expression instanceof O&&(null==(t=e.expression.literal)?void 0:t.kind)===r.COLOR_LITERAL))return!1;const n=e.expression.literal.value;if(4!==n.length&&7!==n.length||"#"!==n[0])return!1;for(let e=1;e<n.length;e+=1)if(!Z(n[e]))return!1;return!0}function ut(e){return void 0===e}function ht(e){var t;return!!(ve(e)||dt(e)||Le(e)&&["true","false","null"].includes(e.expression.variable.value.toLowerCase())||e instanceof L&&st.includes(null==(t=e.op)?void 0:t.value)&&dt(e.expression)||e instanceof g)}function dt(e){var t;return e instanceof R&&e.expression instanceof O&&(null==(t=e.expression.literal)?void 0:t.kind)===r.NUMERIC_LITERAL}function pt(e){var t;if(!(e instanceof L&&lt(null==(t=e.op)?void 0:t.value)))return!1;const n=Be(e.expression).unwrap_or(void 0);return void 0!==n&&n.length>0}function Et(e){return e instanceof k&&e.elementList.every(Ie)}function ft(e){var t;const n={},s=[];if(!e)return new pe({});for(const i of e.elementList){if(!i.name)continue;if(i.name instanceof R){s.push(new de(he.INVALID_SETTINGS,"A setting name must be a stream of identifiers",i.name));continue}const e=null==(t=ye(i.name).unwrap_or(void 0))?void 0:t.toLowerCase();e&&(void 0===n[e]?n[e]=[i]:n[e].push(i))}return new pe(n,s)}class Nt{constructor(e,t){this.ast=e,this.symbolFactory=t,this.publicSchemaSymbol=this.symbolFactory.create(ie,{symbolTable:new qe}),this.ast.symbol=this.publicSchemaSymbol,this.ast.symbol.declaration=this.ast}validate(){const e=[];this.ast.body.forEach((t=>{if(t.parent=this.ast,void 0===t.type)return;const n=new(it(t))(t,this.publicSchemaSymbol.symbolTable,this.symbolFactory);e.push(...n.validate())}));const t=this.ast.body.filter((e=>Me(e).unwrap_or(void 0)===Ue.Project));return t.length>1&&t.forEach((t=>e.push(new de(he.PROJECT_REDEFINED,"Only one project can exist",t)))),new pe(this.ast,e)}}class mt{constructor(e,t){this.declarationNode=e,this.errors=t}bind(){this.bindSettingList(this.declarationNode.attributeList,this.settingList),this.bindBody()}bindSettingList(e,t){if(e)for(const n of e.elementList){if(n.name instanceof R)continue;const e=ye(n.name).unwrap_or(void 0);if(!e)continue;const s=t[e.toLowerCase()];null!=s&&s.shouldBind&&this.scanAndBind(n.value,s)}}bindBody(){const e=this.declarationNode;if(!e.body)return;const{body:t}=e;if(t instanceof w)for(const e of t.body)if(e instanceof b){if(!e.type)continue;new(At(e))(e,this.errors).bind()}else this.bindSubfield(e);else this.bindSubfield(t)}bindSubfield(e){const t=[e.callee,...e.args],n=s.last(t);n instanceof C&&(t.pop(),this.bindSettingList(n,this.subfield.settingList));const{argBinderRules:i}=this.subfield.arg;for(let e=0;e<Math.min(t.length,i.length);e+=1)i[e].shouldBind&&this.scanAndBind(t[e],i[e])}scanAndBind(e,t){var n,s;if(e)if(e instanceof R){if(e.expression instanceof D&&null!=(s=t.keywords)&&s.includes(null==(n=e.expression.variable)?void 0:n.value.toLowerCase()))return;this.bindFragments([e],t)}else e instanceof _?_e(e)?this.bindFragments(Fe(e).unwrap_or([]),t):(this.scanAndBind(e.leftExpression,t),this.scanAndBind(e.rightExpression,t)):e instanceof L||e instanceof y?this.scanAndBind(e.expression,t):e instanceof k&&e.elementList.forEach((e=>this.scanAndBind(e,t)))}bindFragments(e,t){if(0===e.length)return;const n=[...t.topSubnamesSymbolKind],{remainingSubnamesSymbolKind:s}=t,i=e.findIndex((e=>!Ie(e))),r=-1!==i&&Et(e[i])?e[i]:void 0,a=i>=0?n.pop():void 0,o=e.slice(0,-1===i?void 0:i);if(0===o.length)return;const l=[];for(;n.length&&o.length;){const e=n.pop(),t=o.pop(),s=Ke(t).unwrap();l.unshift({index:q(s,e),referrer:t})}for(;o.length;){const e=o.pop(),t=Ke(e).unwrap();l.unshift({index:q(t,s),referrer:e})}return r?r.elementList.forEach((e=>this.resolveIndexStack([...l,{index:q(Ke(e).unwrap(),a),referrer:e}],t.ignoreNameNotFound))):this.resolveIndexStack(l,t.ignoreNameNotFound)}resolveIndexStack(e,t){if(0===e.length)throw new Error("Unreachable - An unresolved name must have at least one name component");const[n,...s]=e,i=je(n.index,this.declarationNode);if(void 0===i){const{kind:e,name:s}=z(n.index).unwrap();return void this.logError(n.referrer,`Can not find ${e} '${s}'`,t)}i.references.push(n.referrer),n.referrer.referee=i;let r=i.symbolTable,{kind:a,name:o}=z(n.index).unwrap();for(const e of s){const{kind:n,name:s}=z(e.index).unwrap(),i=r.get(e.index);if(!i)return void this.logError(e.referrer,`${a} '${o}' does not have ${n} '${s}'`,t);if(a=n,o=s,e.referrer.referee=i,i.references.push(e.referrer),!i.symbolTable)break;r=i.symbolTable}}logError(e,t,n){n||this.errors.push(new de(he.BINDING_ERROR,t,e))}}class Tt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[]},settingList:{}},this.settingList={}}}class bt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1}]},settingList:{}},this.settingList={}}}class vt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}class It extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1}]},settingList:{}},this.settingList={}}}class Lt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[]},settingList:{}},this.settingList={}}}class _t extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}class yt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Enum],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!0}]},settingList:{ref:{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},default:{shouldBind:!1}}},this.settingList={}}}class gt extends mt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}function At(e){switch(e.type.value.toLowerCase()){case Ue.Enum:return bt;case Ue.Table:return yt;case Ue.TableGroup:return gt;case Ue.Project:return Lt;case Ue.Ref:return _t;case Ue.Note:return It;case Ue.Indexes:return vt;default:return Tt}}class wt{constructor(e){this.ast=e,this.errors=[]}resolve(){for(const e of this.ast.body)if(e.type){new(At(e))(e,this.errors).bind()}return new pe(this.ast,this.errors)}}class Ct{constructor(e){this.generator=e}create(e,t){return new e(t,this.generator.nextId())}}class kt{constructor(e,t){this.ast=e,this.symbolFactory=new Ct(t)}analyze(){return new Nt(this.ast,this.symbolFactory).validate().chain((e=>new wt(e).resolve()))}validate(){return new Nt(this.ast,this.symbolFactory).validate().chain((e=>new pe(e,[])))}}function St(e,t){const{variables:n,tupleElements:s}=Ge(e).unwrap();return s?0===n.length?{schemaName:t.schemaName,tableName:t.name,fieldNames:s}:{tableName:n.pop(),schemaName:n.pop()||null,fieldNames:s}:1===n.length?{schemaName:t.schemaName,tableName:t.name,fieldNames:[n[0]]}:{fieldNames:[n.pop()],tableName:n.pop(),schemaName:n.pop()||null}}function xt(e){switch(e){case"<":return["1","*"];case"<>":return["*","*"];case">":return["*","1"];case"-":return["1","1"]}throw new Error("Invalid relation op")}function Ot(e){return{start:{offset:e.startPos.offset,line:e.startPos.line+1,column:e.startPos.column+1},end:{offset:e.endPos.offset,line:e.endPos.line+1,column:e.endPos.column+1}}}function Dt(e){var t;const n=null==(t=Fe(e).unwrap_or(void 0))?void 0:t.pop();return n instanceof k?n.elementList.map((e=>e.referee)):[n.referee]}function Rt(e){const t=Be(e).unwrap();return{name:t.pop(),schemaName:t}}function Pt(e){return e.expression.literal.value}function Ut(e,t){if(Array.isArray(e)){const n=e.map((({id:e})=>e)).sort().join(","),s=t.map((({id:e})=>e)).sort().join(",");return n<s?`${n}-${s}`:`${s}-${n}`}const n=e.id.toString(),s=t.id.toString();return n<s?`${n}-${s}`:`${s}-${n}`}function Mt(e,t){if(Array.isArray(e)){const n=e.map((({id:e})=>e)).sort(),i=t.map((({id:e})=>e)).sort();return s.zip(n,i).every((([e,t])=>e===t))}return e.id===t.id}function Ft(e){const t=e.split("\n"),n=t.slice(t.findIndex((e=>""!==e.trimStart()))),s=n.filter((e=>e.trimStart())),i=Math.min(...s.map((e=>e.length-e.trimStart().length)));return n.map((e=>e.slice(i))).join("\n")}class Bt{constructor(e,t){this.declarationNode=e,this.env=t,this.table={name:void 0,schemaName:void 0,alias:null,fields:[],token:void 0,indexes:[]},this.pkColumns=[]}interpret(){this.table.token=Ot(this.declarationNode),this.env.tables.set(this.declarationNode,this.table);const e=[...this.interpretName(this.declarationNode.name),...this.interpretAlias(this.declarationNode.alias),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)];return this.pkColumns.length>=2&&(this.table.indexes.push({columns:this.pkColumns.map((({name:e,token:t})=>({value:e,type:"column",token:t}))),token:{start:{offset:-1,line:-1,column:-1},end:{offset:-1,line:-1,column:-1}},pk:!0}),this.pkColumns.forEach((e=>e.pk=!1))),e}interpretName(e){const{name:t,schemaName:n}=Rt(e);return n.length>1?(this.table.name=t,this.table.schemaName=n.join("."),[new de(he.UNSUPPORTED,"Nested schema is not supported",e)]):(this.table.name=t,this.table.schemaName=n.length?n[0]:null,[])}interpretAlias(e){if(!e)return[];const t=Ke(e).unwrap_or(null);return t&&(this.env.aliases.push({name:t,kind:"table",value:{tableName:this.table.name,schemaName:this.table.schemaName}}),this.table.alias=t),[]}interpretSettingList(e){var t,n,s;const i=ft(e).getValue();this.table.headerColor=null!=(t=i.headercolor)&&t.length?Pt(null==(s=null==(n=i.headercolor)?void 0:n.at(0))?void 0:s.value):void 0;const[r]=i.note||[];return this.table.note=r&&{value:$e(null==r?void 0:r.value).map(Ft).unwrap(),token:Ot(r)},[]}interpretBody(e){const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.interpretFields(t),...this.interpretSubElements(n)]}interpretSubElements(e){return e.flatMap((e=>{var t;switch(null==(t=e.type)?void 0:t.value.toLowerCase()){case"note":return this.table.note={value:$e(e.body instanceof w?e.body.body[0].callee:e.body.callee).map(Ft).unwrap(),token:Ot(e)},[];case"indexes":return this.interpretIndexes(e)}return[]}))}interpretFields(e){return e.flatMap((e=>this.interpretColumn(e)))}interpretColumn(e){var t,n,i,r,a,o,l,c,u;const h=[],d={};d.name=Ke(e.callee).unwrap();const p=function(e){let t=null;e instanceof x&&(t=e.argumentList.elementList.map((e=>dt(e)?e.expression.literal.value:ve(e)?$e(e).unwrap():Ve(e).unwrap())).join(","),e=e.callee);let n="";for(;e instanceof U;)n=`[${e.indexer.elementList.map((e=>e.name.expression.literal.value)).join(",")}]${n}`,e=e.array;const{name:s,schemaName:i}=Rt(e);return i.length>1?new pe({schemaName:0===i.length?null:i[0],type_name:`${s}${n}${t?`(${t})`:""}`,args:t},[new de(he.UNSUPPORTED,"Nested schema is not supported",e)]):new pe({schemaName:0===i.length?null:i[0],type_name:`${s}${n}${t?`(${t})`:""}`,args:t})}(e.args[0]);d.type=p.getValue(),h.push(...p.getErrors()),d.token=Ot(e),d.inline_refs=[];const E=e.args.slice(1);if(s.last(E)instanceof C){const s=ft(E.pop()).getValue();d.pk=!(null==(t=s.pk)||!t.length)||!(null==(n=s["primary key"])||!n.length),d.increment=!(null==(i=s.increment)||!i.length),d.unique=!(null==(r=s.unique)||!r.length),d.not_null=!(null==(a=s["not null"])||!a.length)||(null==(o=s.null)||!o.length)&&void 0,d.dbdefault=function(e){var t,n,s;if(e){if(ve(e))return{value:$e(e).unwrap(),type:"string"};if(dt(e))return{type:"number",value:Number.parseFloat(e.expression.literal.value)};if(Le(e))return{value:e.expression.variable.value.toLowerCase(),type:"boolean"};if(e instanceof L&&st.includes(null==(t=e.op)?void 0:t.value)&&dt(e.expression)){const t=Number.parseFloat(e.expression.expression.literal.value);return{value:"-"===(null==(n=e.op)?void 0:n.value)?0-t:t,type:"number"}}if(e instanceof g)return{value:null==(s=e.value)?void 0:s.value,type:"expression"};throw new Error("Unreachable")}}(null==(c=null==(l=s.default)?void 0:l.at(0))?void 0:c.value);const p=null==(u=s.note)?void 0:u.at(0);d.note=p&&{value:$e(p.value).map(Ft).unwrap(),token:Ot(p)};const f=s.ref||[];d.inline_refs=f.flatMap((t=>{const[n]=Dt(t.value.expression);if(Mt(n,e.symbol))return h.push(new de(he.SAME_ENDPOINT,"Two endpoints are the same",t)),[];const s=t.value.op,i=Be(t.value.expression).unwrap();let r;if(1===i.length){const[e]=i;r={schemaName:this.table.schemaName,tableName:this.table.name,fieldNames:[e],relation:s.value,token:Ot(t)}}else if(2===i.length){const[e,n]=i;r={schemaName:null,tableName:e,fieldNames:[n],relation:s.value,token:Ot(t)}}else if(3===i.length){const[e,n,a]=i;r={schemaName:e,tableName:n,fieldNames:[a],relation:s.value,token:Ot(t)}}else{h.push(new de(he.UNSUPPORTED,"Nested schema is not supported",t));const e=i.pop(),n=i.pop();r={schemaName:i.join("."),tableName:n,fieldNames:[e],relation:s.value,token:Ot(t)}}const a=this.registerInlineRefToEnv(e,n,r,t);return h.push(...a),0===a.length?r:[]}))}return d.pk||(d.pk=E.some((e=>"pk"===Ve(e).unwrap().toLowerCase()))),d.unique||(d.unique=E.some((e=>"unique"===Ve(e).unwrap().toLowerCase()))),this.table.fields.push(d),d.pk&&this.pkColumns.push(d),h}interpretIndexes(e){return this.table.indexes.push(...e.body.body.map((e=>{var t,n,i,r,a,o,l;const c={columns:[]},u=e;c.token=Ot(u);const h=[u.callee,...u.args];if(s.last(h)instanceof C){const e=ft(h.pop()).getValue();c.pk=!(null==(t=e.pk)||!t.length),c.unique=!(null==(n=e.unique)||!n.length),c.name=$e(null==(r=null==(i=e.name)?void 0:i.at(0))?void 0:r.value).unwrap_or(void 0);const s=null==(a=e.note)?void 0:a.at(0);c.note=s&&{value:$e(s.value).unwrap(),token:Ot(s)},c.type=Ve(null==(l=null==(o=e.type)?void 0:o.at(0))?void 0:l.value).unwrap_or(void 0)}return h.flatMap((e=>{if(!(e instanceof x))return e;const t=[];for(;e instanceof x;)t.push(e.argumentList),e=e.callee;return t.push(e),t})).forEach((e=>{const{functional:t,nonFunctional:n}=Xe(e).unwrap();c.columns.push(...t.map((e=>({value:e.value.value,type:"expression",token:Ot(e)}))),...n.map((e=>({value:Ke(e).unwrap(),type:"column",token:Ot(e)}))))})),c}))),[]}registerInlineRefToEnv(e,t,n,s){const i=Ut(e.symbol,t);if(this.env.refIds[i])return[new de(he.CIRCULAR_REF,"References with same endpoints exist",s),new de(he.CIRCULAR_REF,"References with same endpoints exist",this.env.refIds[i])];const r=xt(n.relation);return this.env.refIds[i]=s,this.env.ref.set(s,{name:null,schemaName:null,token:n.token,endpoints:[{...n,relation:r[1]},{schemaName:this.table.schemaName,tableName:this.table.name,fieldNames:[Ve(e.callee).unwrap()],token:Ot(e),relation:r[0]}]}),[]}}class Gt{constructor(e,t){this.declarationNode=e,this.env=t,this.note={name:void 0,content:void 0,token:void 0}}interpret(){return this.note.token=Ot(this.declarationNode),this.env.notes.set(this.declarationNode,this.note),[...this.interpretName(this.declarationNode.name),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const{name:t}=Rt(e);return this.note.name=t,[]}interpretSettingList(e){var t,n,s;const i=ft(e).getValue();return this.note.headerColor=null!=(t=i.headercolor)&&t.length?Pt(null==(s=null==(n=i.headercolor)?void 0:n.at(0))?void 0:s.value):void 0,[]}interpretBody(e){const[t,n]=s.partition(e.body,(e=>e instanceof A));return 1!==t.length||n.length>0?[new de(he.INVALID_NOTE,"Invalid note syntax",e)]:[...this.interpretNote(t[0])]}interpretNote(e){const t=s.get(e,"callee.expression.literal.value","");return this.note.content=Ft(t),[]}}class Vt{constructor(e,t){this.declarationNode=e,this.env=t,this.container=this.declarationNode.parent instanceof b?this.env.tables.get(this.declarationNode.parent):void 0,this.ref={}}interpret(){return this.ref.token=Ot(this.declarationNode),this.env.ref.set(this.declarationNode,this.ref),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const t=[],n=Be(this.declarationNode.name).unwrap_or([]);return this.ref.name=n.pop()||null,n.length>1&&t.push(new de(he.UNSUPPORTED,"Nested schema is not supported",this.declarationNode.name)),this.ref.schemaName=n.join(".")||null,t}interpretBody(e){return e instanceof A?this.interpretField(e):this.interpretField(e.body[0])}interpretField(e){var t,n,s,i,r,a,o;const l=e.callee.op.value,{leftExpression:c,rightExpression:u}=e.callee,h=Dt(c),d=Dt(u);if(Mt(h,d))return[new de(he.SAME_ENDPOINT,"Two endpoints are the same",e)];const p=Ut(h,d);if(this.env.refIds[p])return[new de(he.CIRCULAR_REF,"References with same endpoints exist",this.declarationNode),new de(he.CIRCULAR_REF,"References with same endpoints exist",this.env.refIds[p])];if(e.args[0]){const l=ft(e.args[0]).getValue(),c=null==(n=null==(t=l.delete)?void 0:t.at(0))?void 0:n.value;this.ref.onDelete=c instanceof v?ye(c).unwrap_or(void 0):Ve(c).unwrap_or(void 0);const u=null==(i=null==(s=l.update)?void 0:s.at(0))?void 0:i.value;this.ref.onUpdate=u instanceof v?ye(u).unwrap_or(void 0):Ve(u).unwrap_or(void 0),this.ref.color=null!=(r=l.color)&&r.length?Pt(null==(o=null==(a=l.color)?void 0:a.at(0))?void 0:o.value):void 0}const E=xt(l);return this.ref.endpoints=[{...St(c,this.container),relation:E[0],token:Ot(c)},{...St(u,this.container),relation:E[1],token:Ot(u)}],this.env.refIds[p]=this.declarationNode,[]}}class Xt{constructor(e,t){this.declarationNode=e,this.env=t,this.tableGroup={tables:[]}}interpret(){const e=[];return this.tableGroup.token=Ot(this.declarationNode),this.env.tableGroups.set(this.declarationNode,this.tableGroup),e.push(...this.interpretName(this.declarationNode.name),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)),e}interpretName(e){const t=[],{name:n,schemaName:s}=Rt(e);return s.length>=2&&(this.tableGroup.name=n,this.tableGroup.schemaName=s.join("."),t.push(new de(he.UNSUPPORTED,"Nested schema is not supported",this.declarationNode.name))),this.tableGroup.name=n,this.tableGroup.schemaName=s[0]||null,t}interpretBody(e){const[t,n]=s.partition(e.body,(e=>e instanceof A));return[...this.interpretFields(t),...this.interpretSubElements(n)]}interpretSubElements(e){return e.flatMap((e=>{var t;if("note"===(null==(t=e.type)?void 0:t.value.toLowerCase()))this.tableGroup.note={value:$e(e.body instanceof w?e.body.body[0].callee:e.body.callee).map(Ft).unwrap(),token:Ot(e)};return[]}))}interpretFields(e){const t=[];return this.tableGroup.tables=e.map((e=>{const n=Be(e.callee).unwrap();n.length>2&&t.push(new de(he.UNSUPPORTED,"Nested schema is not supported",e));const s=Fe(e.callee).unwrap().pop().referee.id;if(this.env.groupOfTable[s]){const i=this.env.groupOfTable[s],{schemaName:r,name:a}=this.env.tableGroups.get(i),o=r?`${r}.${a}`:a;t.push(new de(he.TABLE_REAPPEAR_IN_TABLEGROUP,`Table "${n.join(".")}" already appears in group "${o}"`,e))}else this.env.groupOfTable[s]=this.declarationNode;return{name:n.pop(),schemaName:n.join(".")}})),t}interpretSettingList(e){var t,n,s;const i=ft(e).getValue();this.tableGroup.color=null!=(t=i.color)&&t.length?Pt(null==(s=null==(n=i.color)?void 0:n.at(0))?void 0:s.value):void 0;const[r]=i.note||[];return this.tableGroup.note=r&&{value:$e(null==r?void 0:r.value).map(Ft).unwrap(),token:Ot(r)},[]}}class Kt{constructor(e,t){this.declarationNode=e,this.env=t,this.enum={values:[]}}interpret(){return this.enum.token=Ot(this.declarationNode),this.env.enums.set(this.declarationNode,this.enum),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const{name:t,schemaName:n}=Rt(e);return n.length>1?(this.enum.name=t,this.enum.schemaName=n.join("."),[new de(he.UNSUPPORTED,"Nested schema is not supported",e)]):(this.enum.name=t,this.enum.schemaName=n.length?n[0]:null,[])}interpretBody(e){return e.body.flatMap((e=>{var t;const n=e,s={};s.token=Ot(n),s.name=Ve(n.callee).unwrap();const i=null==(t=ft(n.args[0]).getValue().note)?void 0:t.at(0);return s.note=i&&{value:$e(i.value).map(Ft).unwrap(),token:Ot(i)},this.enum.values.push(s),[]}))}}class $t{constructor(e,t){this.declarationNode=e,this.env=t,this.project={enums:[],refs:[],tableGroups:[],tables:[]}}interpret(){return this.env.project.set(this.declarationNode,this.project),this.project.token=Ot(this.declarationNode),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){if(!e)return this.project.name=null,[];const{name:t}=Rt(e);return this.project.name=t,[]}interpretBody(e){return e.body.flatMap((e=>{var t;const n=e;switch(null==(t=n.type)?void 0:t.value.toLowerCase()){case"table":{const e=new Bt(n,this.env).interpret();return this.project.tables.push(this.env.tables.get(n)),e}case"ref":{const e=new Vt(n,this.env).interpret();return this.project.refs.push(this.env.ref.get(n)),e}case"tablegroup":{const e=new Xt(n,this.env).interpret();return this.project.tableGroups.push(this.env.tableGroups.get(n)),e}case"enum":{const e=new Kt(n,this.env).interpret();return this.project.enums.push(this.env.enums.get(n)),e}case"note":return this.project.note={value:$e(n.body instanceof w?n.body.body[0].callee:n.body.callee).map(Ft).unwrap(),token:Ot(n)},[];default:return this.project[n.type.value.toLowerCase()]=$e(n.body.callee).unwrap(),[]}}))}}class Wt{constructor(e){this.ast=e,this.env={schema:[],tables:new Map,notes:new Map,refIds:{},ref:new Map,enums:new Map,tableGroups:new Map,groupOfTable:{},aliases:[],project:new Map}}interpret(){const e=this.ast.body.flatMap((e=>{switch(Me(e).unwrap_or(void 0)){case Ue.Table:return new Bt(e,this.env).interpret();case Ue.Note:return new Gt(e,this.env).interpret();case Ue.Ref:return new Vt(e,this.env).interpret();case Ue.TableGroup:return new Xt(e,this.env).interpret();case Ue.Enum:return new Kt(e,this.env).interpret();case Ue.Project:return new $t(e,this.env).interpret();default:return[]}}));return new pe(function(e){return{schemas:[],tables:Array.from(e.tables.values()),notes:Array.from(e.notes.values()),refs:Array.from(e.ref.values()),enums:Array.from(e.enums.values()),tableGroups:Array.from(e.tableGroups.values()),aliases:e.aliases,project:Array.from(e.project.values())[0]||{}}}(this.env),e)}}var jt=(e=>(e[e.Function=1]="Function",e[e.Constructor=2]="Constructor",e[e.Field=3]="Field",e[e.Variable=4]="Variable",e[e.Class=5]="Class",e[e.Struct=6]="Struct",e[e.Interface=7]="Interface",e[e.Module=8]="Module",e[e.Property=9]="Property",e[e.Event=10]="Event",e[e.Operator=11]="Operator",e[e.Unit=12]="Unit",e[e.Value=13]="Value",e[e.Constant=14]="Constant",e[e.Enum=15]="Enum",e[e.EnumMember=16]="EnumMember",e[e.Keyword=17]="Keyword",e[e.Text=18]="Text",e[e.Color=19]="Color",e[e.File=20]="File",e[e.Reference=21]="Reference",e[e.Customcolor=22]="Customcolor",e[e.Folder=23]="Folder",e[e.TypeParameter=24]="TypeParameter",e[e.User=25]="User",e[e.Issue=26]="Issue",e[e.Snippet=27]="Snippet",e))(jt||{}),Yt=(e=>(e[e.None=0]="None",e[e.KeepWhitespace=1]="KeepWhitespace",e[e.InsertAsSnippet=4]="InsertAsSnippet",e))(Yt||{});function qt(e){switch(e){case G.Schema:return jt.Module;case G.Table:return jt.Class;case G.Column:return jt.Field;case G.Enum:return jt.Enum;case G.EnumField:return jt.EnumMember;case G.TableGroup:return jt.Struct;case G.TableGroupField:return jt.Field;default:return jt.Text}}function zt(e,t){if(!e||d(e))return!1;for(const n of e.trailingTrivia){if(n.start>t)break;if(n.kind===r.NEWLINE&&n.end<=t)return!1}return!0}function Qt(e){return{...e,suggestions:e.suggestions.map((e=>({...e,insertText:` ${e.insertText}`})))}}function Ht(e){return{...e,suggestions:e.suggestions.map((e=>({...e,insertText:e.insertText.split("").every(H)?e.insertText:`"${e.insertText}"`})))}}function Jt(e,t){return e.getOffsetAt(t)}class Zt{constructor(e,t=[]){this.compiler=e,this.triggerCharacters=t}provideCompletionItems(e,t){var n,s;const i=Jt(e,t),a=this.compiler.token.flatStream(),{token:o,index:l}=this.compiler.container.token(i),c=void 0===l?a[0]:a[l+1];if([...(null==o?void 0:o.trailingTrivia)||[],...(null==o?void 0:o.leadingTrivia)||[],...(null==c?void 0:c.leadingTrivia)||[]].find((e=>function(e){return[r.SINGLE_LINE_COMMENT,r.MULTILINE_COMMENT].includes(e.kind)}(e)&&ne(i,e))))return{suggestions:[]};if(void 0===l)return ln();if([r.STRING_LITERAL,r.QUOTED_STRING].includes(o.kind)&&ne(i,o))return{suggestions:[]};const u=this.compiler.container.element(i);if(this.compiler.container.scopeKind(i)===fn.TOPLEVEL||u instanceof b&&u.type&&u.type.start<=i&&u.type.end>=i)return ln();const h=[...this.compiler.container.stack(i)].reverse();for(const e of h)if(e instanceof L)switch(null==(n=e.op)?void 0:n.value){case">":case"<":case"<>":case"-":return en(this.compiler,i,e)}else if(e instanceof _)switch(null==(s=e.op)?void 0:s.value){case">":case"<":case"<>":case"-":return en(this.compiler,i,e);case".":return an(this.compiler,i,e)}else{if(e instanceof I)return sn(this.compiler,i,e);if(e instanceof C)return sn(this.compiler,i,e);if(e instanceof k)return nn(this.compiler,i);if(e instanceof A)return on(this.compiler,i,e);if(e instanceof b&&(e.bodyColon&&i>=e.bodyColon.end||e.body&&ne(i,e.body)))return on(this.compiler,i,void 0)}return{suggestions:[]}}}function en(e,t,n){const s=e.container.scopeKind(t);if([fn.REF,fn.TABLE].includes(s)){const s=tn(e,t,e.container.element(t),[G.Table,G.Schema,G.Column]);return zt(n.op,t)?Qt(s):s}return{suggestions:[]}}function tn(e,t,n,s){var i;if(void 0===n)return{suggestions:[]};let r=n;const a={suggestions:[]};for(;r;){if(null!=(i=null==r?void 0:r.symbol)&&i.symbolTable){const{symbol:t}=r;a.suggestions.push(...e.symbol.members(t).filter((({kind:e})=>s.includes(e))).map((({name:e,kind:t})=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:qt(t),sortText:qt(t).toString().padStart(2,"0"),range:void 0}))))}r=r instanceof b?r.parent:void 0}return Ht(a)}function nn(e,t){var n;switch(e.container.scopeKind(t)){case fn.INDEXES:return un(e,t);case fn.REF:{const s=[...e.container.stack(t)];for(;s.length>0;){const i=s.pop();if(i instanceof _&&"."===(null==(n=i.op)?void 0:n.value))return an(e,t,i)}}return cn(e,t)}return{suggestions:[]}}function sn(e,t,n){const{token:s}=e.container.token(t);if([r.COMMA,r.LBRACKET].includes(null==s?void 0:s.kind)){const n=rn(e,t);return(null==s?void 0:s.kind)===r.COMMA&&zt(s,t)?Qt(n):n}if(n.name&&n.name.start<=t&&n.name.end>=t)return rn(e,t);if(n.name instanceof v){const e=function(e,t,n){switch(null==n?void 0:n.toLowerCase()){case"update":case"delete":return{suggestions:["cascade","set default","set null","restrict"].map((e=>({label:e,insertText:e,kind:jt.Value,insertTextRules:Yt.KeepWhitespace,range:void 0})))};case"type":return{suggestions:["btree","hash"].map((e=>({label:e,insertText:`${e}`,kind:jt.Value,insertTextRules:Yt.KeepWhitespace,range:void 0})))}}return{suggestions:[]}}(0,0,ye(n.name).unwrap_or(""));return(null==s?void 0:s.kind)===r.COLON&&zt(s,t)?Qt(e):e}return{suggestions:[]}}function rn(e,t){const n=e.container.element(t),s=e.container.scopeKind(t);if(n instanceof T)return{suggestions:[]};if(n.body&&!ne(t,n.body))switch(s){case fn.TABLE:return{suggestions:["headercolor","note"].map((e=>({label:e,insertText:`${e}: `,kind:jt.Field,insertTextRules:Yt.KeepWhitespace,range:void 0})))};case fn.TABLEGROUP:return{suggestions:["color","note"].map((e=>({label:e,insertText:`${e}: `,kind:jt.Field,insertTextRules:Yt.KeepWhitespace,range:void 0})))};default:return{suggestions:[]}}switch(s){case fn.TABLE:return{suggestions:[...["primary key","null","not null","increment","pk","unique"].map((e=>({label:e,insertText:e,kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0}))),...["ref","default"].map((e=>({label:e,insertText:`${e}: `,kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0}))),{label:"note",insertText:"note: ",kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0}]};case fn.ENUM:return{suggestions:[{label:"note",insertText:"note: ",kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0}]};case fn.INDEXES:return{suggestions:[...["unique","pk"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Property,range:void 0}))),...["note","name","type"].map((e=>({label:e,insertText:`${e}: `,kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0})))]};case fn.REF:return{suggestions:["update","delete"].map((e=>({label:e,insertText:`${e}: `,kind:jt.Property,insertTextRules:Yt.KeepWhitespace,range:void 0})))}}return{suggestions:[]}}function an(e,t,n){const s=Fe(n).unwrap_or([]);if(s.pop(),s.some((e=>!Ie(e))))return{suggestions:[]};const i=s.map((e=>Ve(e).unwrap()));return Ht({suggestions:e.symbol.ofName({nameStack:i,owner:e.container.element(t)}).flatMap((({symbol:t})=>e.symbol.members(t))).map((({kind:e,name:t})=>({label:t,insertText:t,kind:qt(e),range:void 0})))})}function on(e,t,n){var s;switch(e.container.scopeKind(t)){case fn.TABLE:return function(e,t,n){if(null==n||!n.callee)return{suggestions:["Note","indexes"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))};const s=hn(t,n);return 0===s?{suggestions:["Note","indexes"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))}:1===s?function(e,t){return{suggestions:[...["integer","int","tinyint","smallint","mediumint","bigint","bit","bool","binary","varbinary","logical","char","nchar","varchar","varchar2","nvarchar","nvarchar2","binary_float","binary_double","float","double","decimal","dec","real","money","smallmoney","enum","tinyblob","tinytext","blob","text","mediumblob","mediumtext","longblob","longtext","ntext","set","inet6","uuid","image","date","time","datetime","datetime2","timestamp","year","smalldatetime","datetimeoffset","XML","sql_variant","uniqueidentifier","CURSOR","BFILE","CLOB","NCLOB","RAW"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.TypeParameter,sortText:jt.TypeParameter.toString().padStart(2,"0"),range:void 0}))),...tn(e,0,e.container.element(t),[G.Enum,G.Schema]).suggestions]}}(e,t):{suggestions:[]}}(e,t,n);case fn.PROJECT:return function(e,t,n){return null!=n&&n.callee?0===hn(t,n)?{suggestions:["Table","TableGroup","Enum","Note","Ref"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))}:{suggestions:[]}:{suggestions:["Table","TableGroup","Enum","Note","Ref"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))}}(0,t,n);case fn.INDEXES:return function(e,t){return un(e,t)}(e,t);case fn.ENUM:return function(e,t,n){return null!=n&&n.callee&&1===hn(t,n)?tn(e,0,e.container.element(t),[G.Schema,G.Table,G.Column]):{suggestions:[]}}(e,t,n);case fn.REF:{const n=cn(e,t);return(null==(s=e.container.token(t).token)?void 0:s.kind)===r.COLON&&zt(e.container.token(t).token,t)?Qt(n):n}case fn.TABLEGROUP:return function(e){return{suggestions:[...Ht({suggestions:[...e.parse.publicSymbolTable().entries()].flatMap((([e])=>{const t=z(e).unwrap_or(void 0);if(void 0===t)return[];const{kind:n,name:s}=t;return n!==G.Table&&n!==G.Schema?[]:{label:s,insertText:s,insertTextRules:Yt.KeepWhitespace,kind:qt(n),range:void 0}}))}).suggestions,...["Note"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))]}}(e);default:return{suggestions:[]}}}function ln(){return{suggestions:["Table","TableGroup","Enum","Project","Ref"].map((e=>({label:e,insertText:e,insertTextRules:Yt.KeepWhitespace,kind:jt.Keyword,range:void 0})))}}function cn(e,t){return tn(e,0,e.container.element(t),[G.Schema,G.Table,G.Column])}function un(e,t){const n=e.container.element(t),s=null==n?void 0:n.parent;if(!((null==s?void 0:s.symbol)instanceof oe))return{suggestions:[]};const{symbolTable:i}=s.symbol;return Ht({suggestions:[...i.entries()].flatMap((([e])=>{const t=z(e).unwrap_or(void 0);if(void 0===t)return[];const{name:n}=t;return{label:n,insertText:n,insertTextRules:Yt.KeepWhitespace,kind:qt(G.Column),range:void 0}}))})}function hn(e,t){if(!t.callee)return-1;const n=[t.callee,...t.args],s=n.findIndex((t=>e<=t.end));return-1===s?n.length:s}class dn{constructor(e){this.compiler=e}provideDefinition(e,t){var n;const{uri:s}=e,i=Jt(e,t),r=[...this.compiler.container.stack(i)];for(;0!==r.length;){const e=r.pop();if(null!=(n=null==e?void 0:e.referee)&&n.declaration&&[m.PRIMARY_EXPRESSION,m.VARIABLE].includes(null==e?void 0:e.kind)){const{startPos:t,endPos:n}=e.referee.declaration;return[{range:{startColumn:t.column+1,startLineNumber:t.line+1,endColumn:n.column+1,endLineNumber:n.line+1},uri:s}]}}return[]}}class pn{constructor(e){this.compiler=e}provideReferences(e,t){const{uri:n}=e,s=Jt(e,t),i=[...this.compiler.container.stack(s)];for(;0!==i.length;){const e=i.pop();if(e&&[m.ELEMENT_DECLARATION,m.FUNCTION_APPLICATION,m.PRIMARY_EXPRESSION].includes(null==e?void 0:e.kind)){const{symbol:t}=e;if(null!=t&&t.references.length)return t.references.map((({startPos:e,endPos:t})=>({range:{startColumn:e.column+1,startLineNumber:e.line+1,endColumn:t.column+1,endLineNumber:t.line+1},uri:n})))}}return[]}}const En=Object.freeze(Object.defineProperty({__proto__:null,CompletionItemInsertTextRule:Yt,CompletionItemKind:jt,DBMLCompletionItemProvider:Zt,DBMLDefinitionProvider:dn,DBMLReferencesProvider:pn},Symbol.toStringTag,{value:"Module"}));var fn=(e=>(e[e.TABLE=0]="TABLE",e[e.ENUM=1]="ENUM",e[e.TABLEGROUP=2]="TABLEGROUP",e[e.INDEXES=3]="INDEXES",e[e.NOTE=4]="NOTE",e[e.REF=5]="REF",e[e.PROJECT=6]="PROJECT",e[e.CUSTOM=7]="CUSTOM",e[e.TOPLEVEL=8]="TOPLEVEL",e))(fn||{});t.Compiler=class{constructor(){this.source="",this.cache=new Array(16).fill(null),this.nodeIdGenerator=new f,this.symbolIdGenerator=new se,this.token={invalidStream:this.createQuery(6,(()=>this.parse.tokens().filter(Ne))),flatStream:this.createQuery(7,(()=>this.parse.tokens().flatMap((e=>[...e.leadingInvalid,e,...e.trailingInvalid]))))},this.parse={source:()=>this.source,_:this.createQuery(0,(()=>{const e=new ge(this.source).lex().chain((e=>new Se(e,this.nodeIdGenerator).parse())).chain((({ast:e,tokens:t})=>new kt(e,this.symbolIdGenerator).analyze().map((()=>({ast:e,tokens:t})))));return e.getErrors().length>0?e:e.chain((({ast:e,tokens:t})=>new Wt(e).interpret().map((n=>({ast:e,tokens:t,rawDb:n})))))})),ast:this.createQuery(1,(()=>this.parse._().getValue().ast)),errors:this.createQuery(2,(()=>this.parse._().getErrors())),tokens:this.createQuery(4,(()=>this.parse._().getValue().tokens)),rawDb:this.createQuery(3,(()=>this.parse._().getValue().rawDb)),publicSymbolTable:this.createQuery(5,(()=>this.parse._().getValue().ast.symbol.symbolTable))},this.container={stack:this.createQuery(10,(e=>{const t=this.token.flatStream(),{index:n,token:i}=this.container.token(e),a=void 0===n?-1:s.findLastIndex(t,(e=>!e.isInvalid),n);if(-1===a)return[this.parse.ast()];const o=t[a].start;let l=this.parse.ast();const u=[l];for(;;){const e=Te(l).find((e=>ne(o,e)));if(void 0===e||e instanceof c)break;u.push(e),l=e}if((null==i?void 0:i.kind)===r.COLON)return u;for(;u.length>0;){let t=!1;const n=s.last(u);if(n instanceof A){const s=this.parse.source();for(let i=n.end;i<e;i+=1)"\n"===s[i]&&(u.pop(),t=!0)}else n instanceof L||n instanceof _?this.container.token(e).token!==n.op&&(u.pop(),t=!0):n instanceof C?n.listCloseBracket&&n.end<=e&&(u.pop(),t=!0):n instanceof k?n.tupleCloseParen&&n.end<=e&&(u.pop(),t=!0):n instanceof w?n.blockCloseBrace&&n.end<=e&&(u.pop(),t=!0):n instanceof v||n.end<e&&(u.pop(),t=!0);if(t){const t=s.last(u);t instanceof b&&t.end<=e&&u.pop()}if(!t)break}return u})),token:this.createQuery(11,(e=>{const t=this.token.flatStream().findIndex((t=>t.start>=e));return void 0===t||t<=0?{token:void 0,index:void 0}:{token:this.token.flatStream()[t-1],index:t-1}})),element:this.createQuery(12,(e=>{const t=this.container.stack(e);for(let e=t.length-1;e>=0;e-=1)if(t[e]instanceof b)return t[e];return this.parse.ast()})),scope:this.createQuery(14,(e=>{var t,n;return null==(n=null==(t=this.container.element(e))?void 0:t.symbol)?void 0:n.symbolTable})),scopeKind:this.createQuery(15,(e=>{var t;if(this.container.element(e)instanceof T)return 8;switch(null==(t=this.container.element(e).type)?void 0:t.value.toLowerCase()){case"table":return 0;case"enum":return 1;case"ref":return 5;case"tablegroup":return 2;case"indexes":return 3;case"note":return 4;case"project":return 6;default:return 7}}))},this.symbol={ofName:this.createQuery(8,(({nameStack:e,owner:t=this.parse.ast()})=>{var n;if(0===e.length)return[];const s=[];for(let i=t;i;i=i instanceof b?i.parent:void 0){if(null==(n=i.symbol)||!n.symbolTable)continue;const{symbolTable:t}=i.symbol;let r=[t],a=[];for(const t of e)a=r.flatMap((e=>Q(t).flatMap((t=>{const n=e.get(t),s=z(t).unwrap_or(void 0);return n&&s?{...s,symbol:n}:[]})))),r=a.flatMap((e=>e.symbol.symbolTable?e.symbol.symbolTable:[]));s.push(...a)}return s}),(({nameStack:e,owner:t})=>`${e.join(".")}@${t.id}`)),members:this.createQuery(9,(e=>e.symbolTable?[...e.symbolTable.entries()].map((([e,t])=>({...z(e).unwrap(),symbol:t}))):[]))}}createQuery(e,t,n){return s=>{const i=this.cache[e],r=s&&n?n(s):s;if(null!==i){if(!(i instanceof Map))return i;if(i.has(r))return i.get(r)}const a=t(s);return void 0!==s?i instanceof Map?i.set(r,a):(this.cache[e]=new Map,this.cache[e].set(r,a)):this.cache[e]=a,a}}setSource(e){this.source=e,this.cache=new Array(16).fill(null),this.nodeIdGenerator.reset(),this.symbolIdGenerator.reset()}initMonacoServices(){return{definitionProvider:new dn(this),referenceProvider:new pn(this),autocompletionProvider:new Zt(this)}}},t.serialize=function(e,t=!1){return JSON.stringify(e,(function(e,t){var n;return this instanceof T||"symbol"!==e?"symbol"===e?{symbolTable:null==t?void 0:t.symbolTable,id:null==t?void 0:t.id,references:null==t?void 0:t.references.map((e=>e.id)),declaration:null==(n=null==t?void 0:t.declaration)?void 0:n.id}:"referee"===e||"parent"===e||"declaration"===e?null==t?void 0:t.id:"symbolTable"===e?Object.fromEntries(t.table):t:null==t?void 0:t.id}),t?2:0)},t.services=En}}]);
